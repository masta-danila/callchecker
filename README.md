# Проект распознавания и анализа диалогов

Этот проект предназначен для загрузки диалогов из базы данных (БД), их распознавания с использованием сервиса Тинькофф, обработки (исправление ошибок, классификация, анализ по критериям c помощью сторонних llm) и последующей загрузки результатов обратно в БД.

Дата последнего обновления: 2 марта 2025 года.

## Основные модули

### Безопасность
- **`.env`**  
  Содержит ключи к сервисам распознавания Тинькофф, доступы к БД, api ключи к ChatGPT и Claude
- **`auth.py::generate_auth_metadata`**  
  Генерирует JWT-токен для авторизации в сервисах Тинькофф, используя API-ключ и секретный ключ из переменных окружения.

### 1. Распознавание диалогов
**`dialog_recognition.py`**  
  Загружает диалоги из БД, распознает их с помощью сервиса Тинькофф и сохраняет результаты обратно в БД.
- **`dialog_processor.py::process_and_store_dialogs`**  
  Принимает словарь с данными из БД, распознает все диалоги, возвращает словарь с обработанными данными.
 - **`dialog_recognizer.py::process_record`**  
    Принимает метаданные аудиофайла, распознает его, возвращает словарь с метаданными и текстом диалога.
    - **`recognition_by_uri.py::recognize_speech`**  
      Принимает метаданные аудиофайла, отправляет запрос на распознавание в Тинькофф, возвращает сырой результат.
    - **`dialog_builder.py::build_dialog_from_response`**  
      Преобразует сырой результат распознавания от Тинькофф в текст диалога с разделением по ролям.

### 2. Анализ диалогов
**`dialog_analysis.py`**  
Выгружает диалоги из БД, корректирует их (ошибки, пунктуация, разбивка на предложения), классифицирует и анализирует по заданным критериям, затем сохраняет результаты в БД.
- **`dialog_fixer_all.py::process_dialogs`**  
  Принимает словарь с диалогами, исправляет их, возвращает словарь с исправленными данными.
  - **`dialog_fixer.py::fix_dialog`**  
    Исправляет текст диалога и возвращает словарь с текстом и стоимостью обработки нейросетью.
- **`dialog_classifier.py::classify_dialogs`**  
  Классифицирует диалоги на основе данных и возвращает обновленный словарь. Отбирает критерии анализа для каждого диалога на основе его классификации.
  - **`classifier.py::assign_category`**  
    Присваивает категории тексту диалога на основе заданного словаря категорий.
- **`criteria_analyzer.py::analyze_criteria`**  
  Анализирует диалоги по заданным критериям и возвращает обновленный словарь.
  - **`criterion_processor.py::process_client_data`**  
    Анализирует диалог по одному критерию, оценивает его и добавляет результаты в словарь.

### Утилиты для работы с БД
- **`db_fetcher.py::fetch_data`**  
  Выгружает данные из БД по заданному статусу и списку полей. Если analytics_mode=True, плюсом подгружает данные для анализа диалогов и связанные сделки. 
  - **`db_client.py::create_db_client`**  
    Создает клиента для подключения к БД.
- **`db_dialog_uploader.py::upload_recognized_dialogs`**  
  Загружает распознанные диалоги в БД с указанным статусом.
- **`db_data_uploader.py::upload_records_from_dict`**  
  Загружает данные из словаря в БД с указанным статусом.

### Работа с нейросетями
- **`llm_router.py::llm_request`**  
Выполняет запрос к любой модели нейросети и возвращает текст ответа и стоимость обработки.
  - **`gpt_request.py::request_chatgpt`**  
  Выполняет запрос к gpt модели нейросети и возвращает текст ответа и стоимость обработки.
  - **`deepseek_request.py::request_deepseek`**  
    Выполняет запрос к deepseek модели нейросети и возвращает текст ответа и стоимость обработки.
  - **`claude_request.py::request_claude`**  
    Выполняет запрос к claude модели нейросети и возвращает текст ответа и стоимость обработки.
- **`llm_response_cleaner.py::clean_llm_content`**  
  Принимает строку content от llm, чистит от \`\`\`json ... \`\`\` и прочих вспомогательных символов, отдает чистую строку
- **`llm_pricing.json`**  
  JSON-файл с прайсами для моделей нейросетей.

## Дополнительные утилиты
**`temp_utils`**  
  На момент обновления документации в проекте не используются.
- **`chatgpt_batch_request.py`**  
  Пакетный запрос к ChatGPT (в 2 раза дешевле, но с ожиданием 18–24 часа).
- **`example_batch_input.jsonl`**  
  Пример файла для пакетного запроса к ChatGPT.
