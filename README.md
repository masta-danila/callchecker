# Проект распознавания и анализа диалогов

Этот проект предназначен для загрузки диалогов из bitrix24, их распознавания с использованием сервиса Тинькофф, обработки (исправление ошибок, классификация, анализ по критериям c помощью сторонних llm) и последующей загрузки результатов обратно в БД.

Дата последнего обновления: 10 августа 2025 года.

## Основные модули

### Bitrix24 интеграция
Модули для работы с Bitrix24 располагаются в папке `bitrix24/`

**`bitrix24/main.py`**  
Главный файл для автоматизации полного цикла обработки звонков из Bitrix24:
- Шаг 1: Получение записей из БД
- Шаг 2: Скачивание недостающих файлов из Bitrix24  
- Шаг 3: Получение данных сущностей CRM
- Шаг 4: Обновление сущностей в БД
- Шаг 5: Получение данных о пользователях
- Шаг 6: Обновление пользователей в БД
- Шаг 7: Получение аудио метаданных и выгрузка файлов в облако
- Шаг 8: Загрузка записей в БД
- Шаг 9: Очистка аудиофайлов после успешной загрузки

**`bitrix24/setup_portals.py`**  
Настройка и создание таблиц БД для порталов из конфигурации `bitrix24/bitrix_portals.json`

**`bitrix24/call_downloader.py`**  
Асинхронное скачивание одного звонка по ID

**`bitrix24/bulk_call_downloader.py`**  
Массовое асинхронное скачивание звонков из всех порталов за указанный период

**`bitrix24/entity_fetcher.py`**  
Получение данных сущностей CRM (контакты, лиды, компании) из Bitrix24

**`bitrix24/entity_db_manager.py`**  
Управление сущностями в БД: создание, обновление и получение внутренних ID

**`bitrix24/users_fetcher.py`**  
Получение данных пользователей из Bitrix24 и добавление их к записям звонков

**`bitrix24/users_db_manager.py`**  
Управление пользователями в БД: создание, обновление записей в таблице {portal}_users

**`bitrix24/audio_processor.py`**  
Асинхронная обработка аудио файлов: получение метаданных и загрузка в S3

**`bitrix24/records_db_manager.py`**  
Управление записями звонков в БД: UPSERT операции с аудио метаданными

**`bitrix24/audio_cleanup.py`**  
Очистка аудиофайлов после успешной загрузки в БД: автоматическое удаление папок при 100% успехе

**`bitrix24/downloads/`**  
Папка для хранения скачанных MP3 файлов звонков, организованных по порталам

**`bitrix24/json_tests/`**  
Папка для отладочных JSON файлов с промежуточными результатами обработки

**`bitrix24/debug_utils.py`**  
Локальная копия утилит для сохранения отладочных данных

### Безопасность
- **`.env`**  
  Содержит ключи к сервисам распознавания Тинькофф, доступы к БД, api ключи к ChatGPT и Claude
- **`auth.py::generate_auth_metadata`**  
  Генерирует JWT-токен для авторизации в сервисах Тинькофф, используя API-ключ и секретный ключ из переменных окружения.

### 1. Распознавание диалогов
**`dialog_recognition.py`**  
  Загружает диалоги из БД, распознает их с помощью сервиса Тинькофф и сохраняет результаты обратно в БД.
- **`dialog_processor.py::process_and_store_dialogs`**  
  Принимает словарь с данными из БД, распознает все диалоги, возвращает словарь с обработанными данными.
 - **`dialog_recognizer.py::process_record`**  
    Принимает метаданные аудиофайла, распознает его, возвращает словарь с метаданными и текстом диалога.
    - **`recognition_by_uri.py::recognize_speech`**  
      Принимает метаданные аудиофайла, отправляет запрос на распознавание в Тинькофф, возвращает сырой результат.
    - **`dialog_builder.py::build_dialog_from_response`**  
      Преобразует сырой результат распознавания от Тинькофф в текст диалога с разделением по ролям.

### 2. Анализ диалогов
**`dialog_analysis.py`**  
Выгружает диалоги из БД, корректирует их (ошибки, пунктуация, разбивка на предложения), классифицирует и анализирует по заданным критериям, затем сохраняет результаты в БД.
- **`dialog_fixer_all.py::process_dialogs`**  
  Принимает словарь с диалогами, исправляет их, возвращает словарь с исправленными данными.
  - **`dialog_fixer.py::fix_dialog`**  
    Исправляет текст диалога и возвращает словарь с текстом и стоимостью обработки нейросетью.
- **`dialog_classifier.py::classify_dialogs`**  
  Классифицирует диалоги на основе данных и возвращает обновленный словарь. Отбирает критерии анализа для каждого диалога на основе его классификации.
  - **`classifier.py::assign_category`**  
    Присваивает категории тексту диалога на основе заданного словаря категорий.
- **`criteria_analyzer.py::analyze_criteria`**  
  Анализирует диалоги по заданным критериям и возвращает обновленный словарь.
  - **`criterion_processor.py::process_client_data`**  
    Анализирует диалог по одному критерию, оценивает его и добавляет результаты в словарь.
- **`entity_summarizer.py::summarize_entity_descriptions`**  
  Создает суммарные описания для сущностей, объединяя тексты критериев с флагом "include_in_entity_description": true. Работает асинхронно с контролем параллельных запросов и размера текста.
  - **`sum_texts.py::sum_text_blocks`**  
    Суммирует множественные блоки текста через LLM с сохранением оценок. Вычисляет средние арифметические оценок и объединяет тексты с учетом максимального размера.


### Утилиты для работы с файлами
- **`audio_metadata.py::get_audio_metadata`**  
  Извлечение метаданных из аудио файлов с помощью ffprobe
- **`upload.py::upload_file_to_storage_async`**  
  Асинхронная загрузка файла в S3 хранилище

### Утилиты для работы с БД
- **`db_create_table.py::create_tables`**  
  Создание таблиц PostgreSQL с поддержкой статусов, категорий, критериев, сущностей и пользователей (users)
- **`db_fetcher.py::fetch_data`**  
  Выгружает данные из БД по заданному статусу и списку полей. Если analytics_mode=True, плюсом подгружает данные для анализа диалогов и связанные сделки. 
  - **`db_client.py::create_db_client`**  
    Создает клиента для подключения к БД.
- **`db_dialog_uploader.py::upload_recognized_dialogs`**  
  Загружает распознанные диалоги в БД с указанным статусом.
- **`db_data_uploader.py::upload_records_from_dict`**  
  Загружает данные из словаря в БД с указанным статусом.

### Работа с нейросетями
- **`llm_router.py::llm_request`**  
Выполняет запрос к любой модели нейросети и возвращает текст ответа и стоимость обработки.
  - **`gpt_request.py::request_chatgpt`**  
  Выполняет запрос к gpt модели нейросети и возвращает текст ответа и стоимость обработки.
  - **`deepseek_request.py::request_deepseek`**  
    Выполняет запрос к deepseek модели нейросети и возвращает текст ответа и стоимость обработки.
  - **`claude_request.py::request_claude`**  
    Выполняет запрос к claude модели нейросети и возвращает текст ответа и стоимость обработки.
- **`llm_response_cleaner.py::clean_llm_content`**  
  Принимает строку content от llm, чистит от \`\`\`json ... \`\`\` и прочих вспомогательных символов, отдает чистую строку
- **`llm_pricing.json`**  
  JSON-файл с прайсами для моделей нейросетей.

## Дополнительные утилиты
**`temp_utils`**  
  На момент обновления документации в проекте не используются.
- **`chatgpt_batch_request.py`**  
  Пакетный запрос к ChatGPT (в 2 раза дешевле, но с ожиданием 18–24 часа).
- **`example_batch_input.jsonl`**  
  Пример файла для пакетного запроса к ChatGPT.
