import asyncio
import json
from llm_router import llm_request


PROMPT = """
Ты профессиональный аналитик и редактор сырых диалогов. Проанализируй диалог менеджера (помечен буквой М) с клиентом (помечен буквой К). 
Определи тематику разговора. Исправь слова в диалоге на их правильное написание согласно тематике если они не подходят 
по контексту всего диалога, например: 
- "посев" на "SEO"; 
- "женская гидроизоляция" на "жидкая гидроизоляция";
- гугл точка ру на google.ru (названия доменов перевести в латиницу);
- восемьсот шестьдесят три на 863 (цифры, цены номера телефонов);
- менеджер собака гмайл точка ком на manager@gmail.com (email перевести в латиницу).
ВАЖНО: Категорически запрещено:
- удалять слова из предложений, даже если они повторяются;
- добавлять новые слова;
- менять порядок слов;
- удалять из диалога метки спикеров (0: и 1:).
НЕОБХОДИМО:
- исправить написание всех слов, не подходящих по контексту на слова согласно тематике;
- добавить знаки препинания;
- изменить строчные буквы на заглавные в начале предложений;
- в конце каждой фразы добавить символ переноса строки;
Также составь краткое резюме разговора. Сформулируй резюме максимально кратко, но при этом понятно, отрази основные моменты.
В резюме спикеров указывай как менеджер и клиент.
В резюме не используй ничего не значащие обороты, типа на настоящий момент, в настоящее время и прочее. 
В резюме не ставь переносы строк.
В резюме сокращай слова и словосочетания в тексте по общепринятым стандартам сокращений. 
В резюме используй официальные правила сокращений, принятые в русском языке.
Ответ выдай строго в виде словаря следующего синтаксиса (без доп символов и кавычек, синтаксис словаря должен быть с 
таким же набором фигурных скобок и двойных кавычек, обрамлять словарь в доп символы запрещено):
{"text": "исправленный текст полностью",
"summary": "резюме разговора"}
Кроме словаря вставлять что-то в ответ запрещено.
Текст диалога:
"""


async def fix_dialog(dialog_text: str) -> dict:
    """
    Асинхронная функция для анализа диалога с помощью chatgpt_request
    :param dialog_text: Текст диалога с метками 0: и 1:
    :return: Ответ от chatgpt_request в виде словаря с исправленным текстом и резюме
    """
    # Заменяем метки 0: и 1: на К: и М: перед отправкой в LLM
    preprocessed_dialog = []
    for line in dialog_text.split("\n"):
        if line.strip().startswith("0:"):
            # 0 - это клиент
            new_line = line.replace("0:", "К:", 1)
        elif line.strip().startswith("1:"):
            # 1 - это менеджер
            new_line = line.replace("1:", "М:", 1)
        else:
            new_line = line
        preprocessed_dialog.append(new_line)
    
    # Объединяем препроцессированный диалог
    preprocessed_text = "\n".join(preprocessed_dialog)
    combined_text = f"{PROMPT}\n\n{preprocessed_text}"

    loop = asyncio.get_running_loop()
    response = await loop.run_in_executor(
        None,
        llm_request,
        'gpt-4o',
        [
            {"role": "user", "content": combined_text}
        ]
    )

    # Разбираем JSON-ответ (теперь {"text": "...", "summary": "..."})
    response_data = json.loads(response["content"])
    fixed_text = response_data["text"]
    summary = response_data["summary"]
    cost = response["cost"]

    return {
        "content": fixed_text,
        "summary": summary,
        "cost": cost
    }


# Пример вызова функции
if __name__ == "__main__":
    sample_dialog = """
    1: добрый день
0: алло здравствуйте
1: здравствуйте
0: я позвонила в объезд про
1: да все верно
0: попала да хотела бы обсудить вот продвижение сайта с кем можно пообщаться
1: со мной меня роман зовут как вас
0: меня зовут анна
1: а
0: роман смотрите
1: да угу
0: да ну сразу к делу
1: конечно
0: да ищем подрядчика на следующий сезон мы компания производитель жидкой гидроизоляции вот но оказываем услуги по устройству этой гидроизоляции под ключ то есть у нас больше би ту би такой сегмент получается
1: угу
0: вот у нас есть сайт по нашим по нашим услугам
1: угу
0: и есть подрядчик сейчас который занимается сео то есть мы все уже занимаемся с двадцатого года где то на уже года четыре наверное
1: угу достаточно долго уже да так
0: да то есть ну в принципе какие то ссылки закупаются какие то работы там делаются то есть там сайт не нулевый домен тоже там с какой то уже с историей
1: истории угу
0: да нужно там какая то раса то есть есть у него вот я что хотела узнать вот сейчас пока вообще просто даже первое такое приближение сейчас подбираем подрядчика скажите пожалуйста вот у вас в среднем да цена за работу над сайтом она сколько ну если иметь в виду что семантическое дрон у нас ну достаточно небольшое да в принципе услуга одна устройство это гидроизоляции
1: угу
0: вот ну и там синонимов там я не знаю ну может быть штук там блин штук пятьдесят наверное максимум там
1: ну я понимаю узкая тематика у вас но регионы у вас по всей россии
0: узко да да
1: получается
0: смотрите региона у нас нет у нас москва московская область и ближайшие области то есть у нас
1: ну понятно ну угу
0: ну да да ну скорее всего ну как бы москва московская область и вот какие то там ну километров пятьсот наверное еще
1: так
0: вот и что еще какая вот нам конечно интересно то есть вот сейчас сел подрядчик который у нас работает да он у нас штатный специалист проблема в чем просто гонит нам трафик да то есть как бы и по трафику у нас рост как бы есть у нас так у нас наверное в целом за год ну трафик небольшой у нас там за год выходит где то восемнадцать тысяч то есть это где то по полторы штуки на по полторы тысячи визитов в месяц вот то есть сейчас вот такие показатели у нас вот но гонят в общем всякий вот шлак туда
1: угу
0: вот а роста заказов мы не видим
1: не целевой ну понятно понятно
0: да то есть да то есть там по конкурентам по каким то вот инфоповодам туда нам туда нагоняют типа сегодня день жестянщика а у нас хорошие цены на там гидроизоляцию да вот нам вот такой вот как бы не нужно нам лучше меньше
1: подход не нужен угу угу по качеству
0: да но нам лучше больше больше заявок вот и нам конечно интересны компании которые у которых есть опыт от работы с такими ну примерно с такими компаниями как мы то есть это вот какие то производители
1: есть есть да
0: да то есть не ком а вот какие то вот такие услуги вот и которые будут заинтересованы именно вот в заявках да нам даже не столь важны топ какой то позиции да пускай это будет
1: угу да мы так работаем мы так и работаем вот у нас есть кипиай рит и в вашем случае я бы ну работал по формату абонемент и премия за именно виды вот но
0: вот да да да отлично
1: но тут есть важные нюансы мы обычно вы как ведете ну работу с клиентами то есть у вас есть црм или вы как в экселе ведете вот
0: ну
1: как у вас акционер
0: ну нет да у нас битрикс двадцать четыре мы работаем у нас есть да срм у нас интегрирован уже растяжка знаю аналитика
1: вот вот вот
0: снимается да с двадцатого года соответственно все предоставляем все доступы отчеты быть да
1: и замечательно замечательно вот ну мы в таких проектах работаем комплексно то есть ну я не знаю у вас это настроено скорее всего у вас есть интегратор какой то да то есть по битриксу то есть кто поддержку оказывает
0: ну
1: вот
0: ну не совсем у нас есть программист который
1: свой угу
0: работает по битриксу вот в принципе но это фриланс надо понимать что не стабильный
1: а у вас коробочная у вас коробочная версия а обл
0: облако нет ну у нас облако да
1: ну программист там не нужен в облаке именно конкретно вот смотрите расскажу в чем суть идеи мы являемся партнерами битрикса то есть и интеграторы и золотые партнеры и в целом посева вы нас нашли в топе вот когда клиентам важны ряды мы работаем по сквозному формату то есть мы становимся интеграторами по битриксу то есть продлеваем лицензию помогаем там либо оказывает тех поддержку как у вас программист например вы ему пишите наверное он там что то делает ну или что то там сломалось например как я представлю мы настраиваем все проверяем цели вот и делаем прогноз по видам то есть сколько рядов привлечем и план с вами согласовываем на первый месяц мы прогноз по дедам не делаем потому что надо поработать с самим сайтом вывести его на первые позиции вот как раз вы сказали шлей слов примерно пятьдесят запросов правильно я понимаю ну такие основные для вас
0: ну да может быть даже меньше то есть у нас вот тут в программе тот сеошник который работает сейчас да а ну у нас сайт там он посвящен услугам но есть раздел который продает сам материал то есть если кому то нужно нужна эта гидроизоляция которая сам будет ее наносить мы конечно ее продадим вот и сеошник он как раз и пытается гнать трафик вот на эту товарную страницу а нам как бы вот
1: я понимаю это бесполезно это бесполезно я понял ошибку основную у нас подход немного другой
0: да да
1: би ту би сложная тематика вот сразу говорю поэтому тут чисто уйдет работа на еды то есть первое это позиции то что то что вот вы назвали если вы не на первом месте то по сути трафик вы теряете ну целевой вот именно те заказчики которые основные вот мы с вами получается обговариваем вот эти цели то есть собираем конверсию фильтруем мусорные заявки от ни мусорных нужно цели оцеживать в том числе и почту потому что могут писать на почту битуби закупки там и так далее вот
0: угу
1: и мы уже работаем конкретно на план по стоимости абонемента он смотрите дело в том что ссылки вообще не работают сейчас в яндексе точно вот поэтому то что вы закупаете ссылки это особого результата не принесет на данный момент вот работает поведенческий фактор вот это основное что дает такой быстрый результат вот я имею в виду топ один топ три то есть вот самый важный запрос потому что даже если вы сейчас уже сами в десятке ну допустим на седьмом месте вы наверное обратили внимание сейчас много занимает реклама
0: угу
1: вот и
0: ну да конечно
1: люди не листают до конца вот люди не решают
0: скоро вообще ничего не будет на первой странице только яндекс свой сервис
1: не ну вряд ли но к этому идет да я понимаю о чем вы говорите вот то есть мы делаем под ключ сео то есть мы можем с вами как договориться ну минимальный бюджет на семьдесят тысяч это с доработками по сайту то есть туда входят услуги там программиста
0: угу
1: и так далее то есть мы сами все делаем то есть вот мы говорим что надо переделать страницу вот это вот это вот это согласовываем с вами и сами реализовываем если
0: угу
1: у вас есть свой программистам и хотите сами реализовывать то бюджет будет там в районе пятидесяти тысяч вот тут надо просто сравнивать дешевле как делать через нас или чем через вашего триста вот плюс еще
0: ну да да да
1: если вам нужно какой нибудь там бантом что то разместить там часы хотелки есть то есть хотелок то есть мы тоже это делаем разумеется
0: угу
1: вот ну такие базовые вещи да то есть
0: угу
1: ну обычно выгоднее через нас делать ну тут все надо смотреть сколько у вас задач обычно бывает сколько вы платите программистам вот по часам или там оклад вы платите то есть надо просто сравнивать с экономическим вот
0: угу
1: что касаемо поведенческого фактора если мы будем работаем с вами по модели абонемент плюс премия за результат то он будет входить вот у нас есть просто абонемент с пф это допустим девяносто тысяч рублей там результат идет практически сразу там первый там второй месяц вот по селу но нужно чтобы было видимость я думаю раз вы занимаете четыре года все вы как минимум там на первой второй странице присутствует скорее всего под этим запросом надо проверить их
0: не факт я говорю не факт что она присутствуем по каким то может быть таким по несколькочасо может быть мы там есть да
1: странно тогда тогда тогда странно очень ну давайте как я вам в любом случае анна напишу либо на ватсап там либо на почту перейдем вы мне вот эти запросы которые вас интересуют пришлете хотя бы основные направления мы соберем позиции ваши да стартовые вот и посмотрим в чем причина вот соответственно после первого месяца мы делаем прогнозы по рядам беря доступа ну можем там по битриксу запартнериться там посмотреть там интерацию настроить и соответственно дальше уже план выполняем вы оплачиваете премию премию тоже индивидуально можем обговорить стоимость заявки там процент выполнения плана без проблем
0: угу
1: вот с первого месяца мы так работать не можем потому что надо понять погрузиться в проект вашу тематику ну мы можем спрогнозировать какие то количество видов исходя из вашей статистики но это опять же будут не точные данные вот и так же хотел уточнить вы используете контекстную рекламу дополнительно вот если да то выхлоп есть от нее какой то вот по вашему опыту
0: ну да ну смотрите да по контексту у нас работает другой подрядчик то есть тут все хорошо у нас мы зашел контекст наверное только и как бы существуем да потому что это реально как бы лиды
1: понял понял угу
0: вот и ну там все налажено
1: нет нет нет я не в плане чтобы забрать и просто почему я спрашиваю если он работает какие запросы наиболее эффективные вот то есть мы просто возьмем эти запросы чтобы вы с органики забирали потому что многие вот би ту би многие закупщики им запрещено с контекста оставлять заявку то есть им говорят надо из выдачи брать но некоторые компании у нас такой есть примеры потому что реклама может любой поставщик купить да то есть качественный он не качественный и добросовестный и недобросовестный непонятно
0: мы пока ну да да да работает да работает контекст работает более менее угу
1: вот а если вы в топе то ну к вам доверие значит больше вот
0: угу угу
1: так по поводу контекста если что если он работает хорошо мы можем запросы просто оттуда взять и посмотреть и их продвинуть ну как вариант
0: угу
1: так по поводу предложения тогда я вам напишу на ватсап вы мне пожалуйста пришлите ссылку на сайт и приоритетные запросы не обязательно прям пятьдесят штук вы можете самые основные по вашему мнению мы по ним посмотрим вот и сделаем аудит то есть я вам подготовлю наше видение то есть что с вашим проектом не так ну по нашему мнению да вот что мы рекомендуем сделать и условия вот также небольшой план работ вам предоставлю да на три месяца чтобы вы могли ознакомиться
0: ну это да это понятно
1: вот
0: это можете не предоставлять тут понятно но
1: угу
0: да нам главное вот получить какой то хотя бы примерное да стоимость работ которые у нас может получаться вот больше в принципе ничего не интересует потому что очень давно все как бы все работы понятны и собственно тут как бы ну
1: тут не совсем но видите вы ссылки закупаете они вообще не нужны по сути ну то есть тут такая ситуация сео меняется вот мы два года допустим на первых позициях посев то есть у нас есть компании которые крупнее нас там они там там типа ингейт демис групп и прочее то есть но они не могут нас опережать то есть потому что у них нет технологий банально современных сео оно развивается то есть то что работало три года назад оно да
0: ну ладно окей да да да да все я просто очень мало времени как бы я поняла хорошо давайте все присылайте тогда пишите мне в ватсап
1: угу да
0: номер у вас определился правильно вот я вам скину
1: да пятьдесят тридцать три на конце я вам сейчас все напишу анна
0: угу да да да да давайте тогда это и продолжим
1: угу
0: потом тогда еще
1: все хорошо да договорились
0: угу да спасибо угу жду тогда спасибо
    """
    # sample_dialog = ""

    result = asyncio.run(fix_dialog(sample_dialog))
    print(result)
