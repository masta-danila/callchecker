import asyncio
from criterion_processor import process_client_data
from logger_config import setup_logger

# Настройка логгера для этого модуля
logger = setup_logger('criteria_analyzer', 'logs/criteria_analyzer.log')


async def analyze_criteria(
    input_data: dict,
    max_retries: int,
    retry_delay: float,
    max_concurrent_requests: int
) -> dict:
    """
    Асинхронно обрабатывает данные клиентов из новой структуры словаря.
    Для каждого клиента и каждой записи проходит по списку критериев и
    запускает process_client_data. В результат записывает в каждое поле
    критериев доп. ключи text и evaluation.

    :param input_data: Словарь с данными клиентов. У каждого клиента есть:
                       - records: список разговоров,
                       - criteria: список определений критериев,
                       - categories, entities (игнорируются в этой функции).
    :param max_retries: Количество попыток при ошибке.
    :param retry_delay: Задержка перед повтором в секундах.
    :param max_concurrent_requests: Максимальное число параллельных запросов.
    :return: То же самое input_data, но в каждом criterion добавлены поля
             "text" и "evaluation".
    """
    semaphore = asyncio.Semaphore(max_concurrent_requests)
    tasks = []

    async def process_with_retries(dialogue: str, criterion: dict, record_id: str):
        for attempt in range(1, max_retries + 1):
            try:
                # Ограничиваем параллелизм
                async with semaphore:
                    result = await process_client_data(dialogue, criterion)
                logger.debug(f"[OK]   ID={record_id!r}, критерий={criterion.get('name')!r}, попытка={attempt}")
                return result
            except Exception as e:
                logger.warning(f"[ERR]  ID={record_id!r}, критерий={criterion.get('name')!r}, попытка={attempt}: {e}")
                if attempt < max_retries:
                    await asyncio.sleep(retry_delay)
                else:
                    logger.error(f"[FAIL] ID={record_id!r}, критерий={criterion.get('name')!r} — исчерпаны все {max_retries} попыток")
                    return None

    # Собираем все задачи в один список
    total_criteria_count = 0
    for client, client_block in input_data.items():
        records = client_block.get("records", [])
        criteria_definitions = client_block.get("criteria", [])
        for record in records:
            dialogue = record.get("dialogue", "")
            record_id = record.get("id", "<no-id>")
            # Список ссылок на критерии в этой записи
            crit_refs = record.get("data", {}).get("criteria", [])
            for crit_ref in crit_refs:
                # Находим полное определение критерия (чтобы взять prompt, правила и т.д.)
                full_crit = next(
                    (c for c in criteria_definitions if c["id"] == crit_ref.get("id")),
                    crit_ref
                )
                # создаём корутину, но не запускаем её сразу, а в gather ниже
                coro = process_with_retries(dialogue, full_crit, record_id)
                tasks.append((crit_ref, coro))
                total_criteria_count += 1

    logger.info(f"Начинаю анализ {total_criteria_count} критериев")
    
    # Параллельно выполняем все запросы
    results = await asyncio.gather(*(t[1] for t in tasks))
    
    logger.info(f"Завершен анализ критериев")

    # Распаковываем результаты обратно в crit_refs
    for (crit_ref, _), processed in zip(tasks, results):
        if processed is not None:
            crit_ref["text"] = processed.get("text")
            crit_ref["evaluation"] = processed.get("evaluation")
        else:
            crit_ref["text"] = None
            crit_ref["evaluation"] = None

    return input_data

# Пример использования
if __name__ == "__main__":
    import json
    data_dict_example = {
    "advertpro": {
        "records": [
            {
                "id": "2025-01-29 16-32-34 +79067571133.mp3",
                "dialogue": "К: Алло, да.\nМ: Алло.\nК: Сбросилось. В общем, тогда завтра я вам все высылаю, списываемся, убираем время и обсуждаем. Вот уже т бизнес нет. Все, Евгений, хорошего вечера, до завтра.\nМ: Да, угу, да, да, да, да, спасибо, до завтра.\nК: До свидания.\n",
                "data": {
                    "categories": [
                        {
                            "id": 22,
                            "name": "Не определен"
                        }
                    ],
                    "criteria": []
                },
                "user_id": 1,
                "entity_id": 1
            },
            {
                "id": "2025-03-11 15-11-25 +79214078077.mp3",
                "dialogue": "М: Добрый день.\nК: Алло, здравствуйте.\nМ: Здравствуйте.\nК: Я позвонила в АдвертПро.\nМ: Да, всё верно.\nК: Попала, да, хотела бы обсудить вот продвижение сайта. С кем можно пообщаться?\nМ: Со мной. Меня Роман зовут. Как вас?\nК: Меня зовут Анна.\nМ: А.\nК: Роман, смотрите.\nМ: Да, угу.\nК: Да, ну сразу к делу.\nМ: Конечно.\nК: Да, ищем подрядчика на следующий сезон. Мы компания - производитель жидкой гидроизоляции вот, но оказываем услуги по устройству этой гидроизоляции под ключ. То есть у нас больше B2B такой сегмент получается.\nК: Вот у нас есть сайт по нашим по нашим услугам.\nМ: Угу.\nК: И есть подрядчик сейчас, который занимается SEO, то есть мы всё уже занимаемся с 2020 года, где-то на уже года четыре, наверное.\nМ: Угу, достаточно долго уже, да, так.\nК: Да, то есть ну в принципе какие-то ссылки закупаются, какие-то работы там делаются, то есть там сайт не нулевой, домен тоже там с какой-то уже с историей.\nМ: Истории, угу.\nК: Да, нужно там какая-то раз, то есть есть у него вот. Я что хотела узнать вот сейчас пока вообще просто даже первое такое приближение, сейчас подбираем подрядчика. Скажите, пожалуйста, вот у вас в среднем, да, цена за работу над сайтом, она сколько? Ну если иметь в виду, что семантическое ядро у нас ну достаточно небольшое, да, в принципе услуга одна - устройство гидроизоляции.\nМ: Угу.\nК: Вот ну и там синонимов там я не знаю, ну может быть штук там блин штук пятьдесят, наверное, максимум там.\nМ: Ну я понимаю, узкая тематика у вас, но регионы у вас по всей России?\nК: Узко, да-да.\nМ: Получается?\nК: Смотрите, региона у нас нет, у нас Москва, Московская область и ближайшие области, то есть у нас.\nМ: Ну понятно, ну угу.\nК: Ну да, да, ну скорее всего ну как бы Москва, Московская область и вот какие-то там, ну километров пятьсот, наверное, ещё.\nМ: Так.\nК: Вот, и чего ещё какая вот. Нам конечно интересно, то есть вот сейчас SEO подрядчик который у нас работает, да, он у нас штатный специалист. Проблема в чём: просто гонит нам трафик, да, то есть как бы и по трафику у нас рост как бы есть. У нас так у нас наверное в целом за год ну трафик небольшой, у нас там за год выходит где-то восемнадцать тысяч, то есть это где-то по полторы штуки на, по полторы тысячи визитов в месяц вот. То есть сейчас вот такие показатели у нас вот, но гонят в общем всякий вот шлак туда.\nМ: Угу.\nК: Вот, а роста заказов мы не видим.\nМ: Не целевой, ну понятно, понятно.\nК: Да, то есть да, то есть там по конкурентам, по каким-то вот инфоповодам туда нам туда нагоняют, типа сегодня день жестянщика, а у нас хорошие цены на там гидроизоляцию, да, вот нам вот такой вот как бы не нужно, нам лучше меньше.\nМ: Подход не нужен, угу, угу, по качеству.\nК: Да, но нам лучше больше, больше заявок. И нам конечно интересны компании, у которых есть опыт работы с такими, ну примерно с такими компаниями как мы, то есть это вот какие-то производители.\nМ: Есть, есть, да.\nК: Да, то есть не ком, а вот какие-то вот такие услуги, вот, и которые будут заинтересованы именно вот в заявках, да, нам даже не столь важны топ, какой-то позиции, да, пускай это будет.\nМ: Угу, да, мы так работаем, мы так и работаем, вот у нас есть KPI, и в вашем случае я бы ну работал по формату: абонемент и премия за именно виды вот, но.\nК: Вот, да-да-да, отлично.\nМ: Но тут есть важные нюансы: мы обычно, вы как ведёте, ну работу с клиентами, то есть у вас есть CRM или вы как в Excel ведёте, вот?\nК: Ну.\nМ: Как у вас организовано?\nК: Ну нет, да, у нас Битрикс24, мы работаем, у нас есть, да, CRM, у нас интегрирован уже растяжка знаю аналитика.\nМ: Вот-вот-вот.\nК: Снимается, да, с 2020 года, соответственно, всё предоставляем, все доступы, отчёты быть, да.\nМ: И замечательно, замечательно, вот. Ну мы в таких проектах работаем комплексно, то есть, ну я не знаю у вас это настроено, скорее всего, у вас есть интегратор какой-то, да, то есть по Битриксу, то есть кто поддержку оказывает?\nК: Ну.\nМ: Вот.\nК: Ну не совсем, у нас есть программист, который.\nМ: Свой, угу.\nК: Работает по Битриксу, вот в принципе, но это фриланс, надо понимать что нестабильный.\nМ: А у вас коробочная, у вас коробочная версия, а облачная?\nК: Облако нет, ну у нас облако, да.\nМ: Ну программист там не нужен в облаке именно конкретно. Вот смотрите, расскажу в чём суть идеи: мы являемся партнёрами Битрикса, то есть и интеграторы, и золотые партнёры, и в целом по SEO, вы нас нашли в топе. Вот, когда клиентам важны лиды, мы работаем по сквозному формату, то есть мы становимся интеграторами по Битриксу, то есть продлеваем лицензию, помогаем там либо оказываем техподдержку, как у вас программист, например, вы ему пишите наверное он там что-то делает, ну или что-то там сломалось, например, как я представлю, мы настраиваем всё, проверяем цели вот и делаем прогноз по лидам, то есть сколько лидов привлечём и план с вами согласовываем на первый месяц. Мы прогноз по лидам не делаем, потому что надо поработать с самим сайтом, вывести его на первые позиции. Вот как раз вы сказали шлей слов примерно пятьдесят запросов, правильно я понимаю? Ну такие основные для вас.\nК: Ну да, может быть даже меньше, то есть у нас вот тут в программе тот SEOшник, который работает сейчас, да, а ну у нас сайт там он посвящён услугам, но есть раздел, который продаёт сам материал, то есть если кому-то нужна эта гидроизоляция, который сам будет её наносить, мы конечно её продадим вот, и SEOшник он как раз и пытается гнать трафик вот на эту товарную страницу, а нам как бы вот.\nМ: Я понимаю, это бесполезно, это бесполезно, я понял ошибку основную, у нас подход немного другой.\nК: Да, да.\nМ: B2B сложная тематика, вот сразу говорю, поэтому тут чисто уйдёт работа на лиды, то есть первое это позиции, то что вот вы назвали, если вы не на первом месте, то по сути трафик вы теряете, ну целевой, вот именно те заказчики, которые основные. Вот мы с вами получается обговариваем вот эти цели, то есть собираем конверсию, фильтруем мусорные заявки от немусорных, нужно цели отслеживать, в том числе и почту, потому что могут писать на почту B2B закупки там и так далее вот.\nК: Угу.\nМ: И мы уже работаем конкретно на план по стоимости: абонемента он смотрите, дело в том что ссылки вообще не работают сейчас в Яндексе точно вот, поэтому то что вы закупаете ссылки это особого результата не принесёт на данный момент вот, работает поведенческий фактор вот это основное, что даёт такой быстрый результат вот, я имею в виду топ один, топ три, то есть вот самый важный запрос, потому что даже если вы сейчас уже сами в десятке, ну допустим на седьмом месте вы наверное обратили внимание сейчас много занимает реклама.\nК: Угу.\nМ: Вот и.\nК: Ну да, конечно.\nМ: Люди не листают до конца.\nК: Скоро вообще ничего не будет на первой странице, только Яндекс свой сервис.\nМ: Не, ну вряд ли, но к этому идёт, да, я понимаю о чём вы говорите, вот, то есть мы делаем под ключ SEO, то есть мы можем с вами как договориться: ну минимальный бюджет на семьдесят тысяч, это с доработками по сайту, то есть туда входят услуги там программиста.\nК: Угу.\nМ: И так далее, то есть мы сами всё делаем, то есть вот мы говорим что надо переделать страницу вот это, вот это, вот это согласовываем с вами и сами реализовываем если.\nК: Угу.\nМ: У вас есть свой программист, и вы хотите сами реализовывать, то бюджет будет там в районе пятидесяти тысяч, вот тут надо просто сравнивать, дешевле как делать через нас или чем через вашего программиста, вот плюс ещё.\nК: Ну да, да, да.\nМ: Если вам нужно какой-нибудь там баннер что-то разместить, там все хотелки есть, то есть хотелок, то есть мы тоже это делаем разумеется.\nК: Угу.\nМ: Вот, ну такие базовые вещи да, то есть.\nК: Угу.\nМ: Ну обычно выгоднее через нас делать, ну тут всё надо смотреть, сколько у вас задач обычно бывает, сколько вы платите программисту, вот по часам или там оклад вы платите, то есть надо просто сравнивать с экономическим, вот.\nК: Угу.\nМ: Что касаемо поведенческого фактора, если мы будем работать с вами по модели абонемент плюс премия за результат, то он будет входить, вот у нас есть просто абонемент с ПФ, это допустим девяносто тысяч рублей там, результат идёт практически сразу, там первый, там второй месяц, вот по SEO, но нужно чтобы была видимость, я думаю раз вы занимает четыре года SEO, вы как минимум там на первой второй странице присутствует, скорее всего под этим запросом, надо проверить их.\nК: Не факт, я говорю не факт, что она присутствуем по каким-то может быть, таким по нескольким часам может быть мы там есть, да.\nМ: Странно тогда, тогда, тогда странно очень, ну давайте как я вам в любом случае Анна напишу либо на WhatsApp там, либо на почту перейдём, вы мне вот эти запросы, которые вас интересуют, пришлёте хотя бы основные направления, мы соберём позиции ваши, да, стартовые, вот и посмотрим в чем причина, вот соответственно после первого месяца мы делаем прогнозы по лидам, беря доступа, ну можем там по Битриксу запартнериться там, посмотреть там интеграцию настроить и соответственно дальше уже план выполняем, вы оплачиваете премию, премию тоже индивидуально можем обговорить стоимость заявки, там процент выполнения плана без проблем.\nК: Угу.\nМ: Вот, с первого месяца мы так работать не можем, потому что надо понять, погрузиться в проект, вашу тематику, ну мы можем спрогнозировать какие то количество лидов исходя из вашей статистики, но это опять же будут не точные данные, вот и так же хотел уточнить, вы используете контекстную рекламу дополнительно вот, если да, то выхлоп есть от неё какой-то, вот по вашему опыту?\nК: Ну да, ну смотрите, да по контексту у нас работает другой подрядчик, то есть тут всё хорошо у нас, мы за счёт контекста, наверное, только и как бы существуем, да, потому что это реально как бы лиды.\nМ: Понял, понял, угу.\nК: Вот и ну там всё налажено.\nМ: Нет-нет-нет, я не в плане чтобы забрать ее, просто почему я спрашиваю, если он работает, какие запросы наиболее эффективные, вот, то есть мы просто возьмём эти запросы, чтобы вы с органики забирали, потому что многие вот B2B, многие закупщики им запрещено с контекста оставлять заявку, то есть им говорят надо из выдачи брать, но некоторые компании у нас такой есть примеры, потому что реклама может любой поставщик купить, да, то есть качественный он не качественный и добросовестный и недобросовестный, непонятно.\nК: Мы пока, ну да, да, да, работает, да работает, контекст работает более менее угу.\nМ: Вот, а если вы в топе, то ну к вам доверие значит больше, вот.\nК: Угу, угу.\nМ: Так, по поводу контекста, если что, если он работает хорошо, мы можем запросы просто оттуда взять и посмотреть и их продвинуть, ну как вариант.\nК: Угу.\nМ: Так, по поводу предложения тогда я вам напишу на WhatsApp, вы мне пожалуйста пришлите ссылку на сайт и приоритетные запросы, не обязательно прям пятьдесят штук, вы можете самые основные по вашему мнению, мы по ним посмотрим вот и сделаем аудит, то есть я вам подготовлю наше видение, то есть что с вашим проектом не так, ну по нашему мнению, да, вот, что мы рекомендуем сделать и условия, вот, также небольшой план работ вам предоставлю, да, на три месяца, чтобы вы могли ознакомиться.\nК: Ну это да, это понятно.\nМ: Вот.\nК: Это можете не предоставлять, тут понятно, но.\nМ: Угу.\nК: Да, нам главное вот получить какой-то хотя бы примерный, да, стоимость работ, которые у нас может получаться, вот больше в принципе ничего не интересует, потому что очень давно всё как бы все работы понятны и собственно тут как бы ну.\nМ: Тут не совсем, но видите вы, ссылки закупаете, они вообще не нужны по сути, ну то есть тут такая ситуация, SEO меняется, вот, мы два года допустим на первых позициях. Поэтому то есть у нас есть компании, которые крупнее нас, там они, там там типа Ingate, Demis Group и прочее, то есть но они не могут нас опережать, то есть потому что у них нет технологий банально современных SEO оно развивается, то есть то, что работало три года назад, оно да.\nК: Ну ладно, окей, да, да, да, да, всё, я просто очень мало времени как бы, я поняла, хорошо, давайте, всё присылайте тогда, пишите мне в WhatsApp.\nМ: Угу, да.\nК: Номер у вас определился правильно, вот я вам скину.\nМ: Да, пятьдесят тридцать три на конце, я вам сейчас всё напишу, Анна.\nК: Угу, да, да, да, да, давайте тогда это и продолжим.\nМ: Угу.\nК: Потом тогда ещё.\nМ: Всё хорошо, да, договорились.\nК: Угу, да, спасибо, угу, жду тогда, спасибо.\n",
                "data": {
                    "categories": [
                        {
                            "id": 1,
                            "name": "Продвижение сайтов новый клиент"
                        }
                    ],
                    "criteria": [
                        {
                            "id": 1,
                            "name": "Ясность речи"
                        },
                        {
                            "id": 21,
                            "name": "Возражения"
                        }
                    ]
                },
                "user_id": 1,
                "entity_id": 2
            },
            {
                "id": "2025-02-07 14-44-47 +79067571133.mp3",
                "dialogue": "К: Алло.\nМ: Два текста сейчас расскажу. Смотрите, тексты делаем мы, и они, если брать карточки, они не прям уникальные, то есть они шаблонные, как и везде. Ну, то есть именно в самих карточках, но в разделах будет уникальный текст делом. То есть мы берём у вас характеристики дверей, цены там и так далее, и загружаемые подразделы идут такие уникальные тексты. То есть любой сайт, вы дверные зайдёте, там так и сделано у всех. Может, двери, например, можете зайти, то есть вот будет примерно так же. То есть текст с нашей стороны, они будут заложены... ну, нами сделаны, а карточкой будет заниматься отдельный человек скрывался. То есть вы им будете высылать фотографии, он их будет обрабатывать, монтировать видео, вот.\nК: Я понял. Давайте на понедельник встречу к обеду сделаем.\nМ: К обеду с Екатериной. Давайте, да-да, давайте я, наверное, какого-то SEO-шника лучше ещё позову, как раз чтобы по текстам она показала, рассказала, кто людьми занимается.\nК: Да-да, не вопрос, не вопрос. Я буду как раз просто с Юлей в понедельник полдня.\nМ: Так вот, давайте секунду, двенадцать, да. Сейчас я просто по времени смотрю, так двенадцать ноль-ноль.\nК: Я думал мы как раз, давайте в двенадцать.\nМ: Давайте.\nК: Давайте, не вопрос. Просто этот, мы сейчас за выходные с ней обдумаем все-все вопросы, обдумаем ваши материалы, и...\nМ: Ну, смотрите, да-да-да, смотрите. Вот если по карточкам, получается шестьсот их максимум, да, получается даже если по четыреста будет, двести сорок тысяч вот это вот эта работа этого специалиста. Вот у нас это стоило полтора миллиона рублей, да, то есть, ну, тысяча рублей стоило. Короче, поэтому, ну, это неадекватно дорого, я понимаю. Вот поэтому вот рева нашёл, соответственно, по текстам, но это там многие тексты, они всё равно потом меняются, потому что всё же меняется, то есть там текст постоянно обновляется, то есть как бы Яндекс за этим следит. Поэтому да, приглашу, вопросы подготовить как раз к встрече, вот те которые вас волнуют, и мы всё решим в понедельник.\nК: У, да, у меня один вопрос. Я знаю на него ответ, но хочу удостовериться.\nМ: Так.\nК: Сначала как на физика, допустим, на Юлю делаем сайт, потому что на мне стоит другой сайт, да, на Юлю делаем сайт и...\nМ: Угу.\nК: Скажите мне, и после этого я сделаю как на физлицо, после этого я открою какую-то там на себя ИП дополнительную, потом вы кинете...\nМ: Ну смотрите, сайт, домен надо оформлять на физика, вот с нами договор можете хоть на юрлицо, это не важно. Ну, то есть мы с физиками не работаем.\nК: Да-да, не с вами, я с вами разберусь, мне за вас не волнует, меня волнует, могу ли я сначала просто оформить сайт как на физика, а потом как в мае месяце, когда вы скажете всё, мы готовы выпускаться, да выходить в эфир, я открываю ИП и оформляю его на ИП-шку.\nМ: А, да, сайт, да, угу, можно, можно, но только единственное что, там надо будет вы в Москве же, а вы в Клину, ну в Москву надо будет съездить с паспортом, вот там в Rek.ru, где будет домен зарегистрирован, написать заявление, что на вас переоформляется момент. Это в личной встрече надо делать.\nК: Да мне домен не надо, я именно за сам сайт спрашиваю.\nМ: Не-не-не, смотрите, объясню. Сайт не важно на кого оформлен, вот именно сам сайт это файл, то есть как папка. Вот самое важное — домен, вот потому что юридически домен считается сайтом, вот и домены должны быть на разные юрлица, чтобы продвигаться могли.\nК: Правильно, правильно, поэтому я и хочу еще открыть дополнительно.\nМ: Вот, и это домен, именно домен, поэтому я бы вообще на вашем месте не торопился с этим, то есть вы можете спокойно ИП открыть и уже домен купить на ИП, чтобы не переоформлять.\nК: Да не могу я купить домен на ИП, потому что...\nМ: Угу.\nК: Первое, ИП будет на меня, я могу это только сделать в мае.\nМ: А, понял, ну...\nК: Поэтому у меня, я уточняю. Это первое, второе, на меня уже Royal, ну мой основной сайт сделан, я не хочу делать эту индексацию, так сказать, чтоб увидели, что на мне куча сайтов, а Яндекс всё равно где-то это видит.\nМ: Ну да, это не очень хорошо, да-да-да, нельзя, нельзя так делать правильно, да.\nК: Ну так, я вот здесь и хочу, да, просто сейчас оформить на Юлю.\nМ: Без проблем, без проблем, угу.\nК: А потом просто сделать на ИП, на какую-то юридическую компанию, ну или я может найду...\nМ: Как хотите, тут можно так сделать.\nК: Найду какую-то компанию.\nМ: Без проблем. Ну, можно сайт оформлять как на физика, так и на юрика, главное, чтобы разные, ну как бы люди были.\nК: Правильно, я и вопрос здесь вот. Сначала физик, потом можно на юрик.\nМ: Можно, можно, да, но это надо будет ей лично ехать в Rek.ru там писать заявление.\nК: Вот у меня...\nМ: Переоформление.\nК: Так, опять же так и не понял, зачем писать заявление.\nМ: А это правило, то есть вы же регистрируете это, domain.ru, ну это по законодательству так вот, это собственность, это машина купили, например, она оформлена на вас.\nК: Угу.\nМ: Вот, соответственно, для того чтобы её кому-то подарить или продать, нужно тоже оформить договор передачи, вот а он только, ну как, без проблем мошенничества, потому что может мало ли там вы позвоните, скажите, представитесь Юлей и скажите, сайт мой, там типа переделайте. Им надо лично видеть, что этот человек, паспорт его, что сайт действительно, потому что вот есть пример, смотрите, вы оплачиваете домен каждый год, да, чтобы он продлевался, там какая-то сумма, если вы забудете заплатить...\nК: Угу.\nМ: Он будет в свободном плавании, и, допустим, люди могут подловить, купить его, и вам придётся у них уже выкупать. Они бывают дорого стоят, вот, есть компании, которые мониторят, чтобы домен украсть вот так, поэтому там всё серьёзно.\nК: А вопрос то у меня не в этом же был.\nМ: Ну то что можно переоформить, да можно конечно. Вопрос просто, что это не так просто сделать, не быстро это будет.\nК: Хреново.\nМ: Да нет, мы поможем, ничего страшного, такие ситуации бывают. Вот соответственно, я думаю не проблема будет делать.\nК: Ага.\nМ: Просто некоторым людям приходится из Владивостока прилетать в Москву, то есть даже такое вот.\nК: Добро, давайте.\nМ: Вы хотя бы рядом.\nК: Я понял, а скажите пожалуйста, а вы не занимаетесь, я хочу запатентовать свой старый сайт и потом, соответственно, когда вы мне выдадите его, давать еще этот новый сайт.\nМ: Угу. Я не знаю, могу уточнить у коллег, делали такое, я сейчас не сталкивался с патентами.\nК: Да, как бы я раньше...\nМ: Вот, угу.\nК: Был связан с юридическими точками, и это стоило-стоило восемнадцать тысяч в двадцать первом году.\nМ: Угу.\nК: Сам факт, что я не заморачивался, я не знаю что, ну, тонкости.\nМ: Я понял, я уточню у коллег.\nК: Поэтому, блин, вот это...\nМ: Если что, поможем, если это сделать.\nК: Беготня вот это вот, правильное оформление, вот не знаешь как правильно.\nМ: Угу, хорошо, подскажем, тогда уточню, конечно.\nК: Да, и соответственно, это дай бог, чтобы он получился всё хорошо, соответственно, его тоже патентовать.\nМ: Решим тогда.\nК: Поэтому мы сейчас с Юлей мы можем, получается, заключая с вами договор, вы начинаете делать, а потом название или здесь будет зависеть тоже сильно от домена.\nМ: Позже можно, позже. Поэтому я вам и говорю, что чисто теоретически, можете успеть на юрлицо сразу сделать, если в мае он будет готов, юрлицо откроете вот. А вы на себя как физика вы не хотите оформить. Просто какая разница? А, вы как физики были, а, уже есть. Понял, понял, хорошо, хорошо. Тогда я тогда обсудим тогда в понедельник, я ещё с Екатериной посоветуюсь.\nК: А на мне уже есть пару сайтов, да. А если получается, у меня есть домен, мы этот ваш, вы делаете на моём домене сайт.\nМ: Угу, угу.\nК: А потом в мае месяце я открываю ИП на себя.\nМ: Угу.\nК: А я регистрирую его на него и меняю название.\nМ: Угу.\nК: Новый домен это плохо, если будет новый домен.\nМ: Ну, можно, нет, почему, можно вес передать старого домена на новый, то есть вот это вес, он имеет каждый домен, ну историю, грубо говоря, то есть более старый домен они лучше прям молодых. Вот поэтому можно вес передать.\nК: Что, заморочиться?\nМ: Ну, ну мы в этом разбираемся.\nК: Заморочиться получается, может у кого-то купить домен.\nМ: Да-да, можно купить старые домены и в один их слить вес, это дроп называется, дроп замен, то есть вы покупаете, ну не знаю какой, дверь.ру, ну образно, там дверь.москва, вот, и покупаете старые домены какие-то, и просто вес их передаётся новому. Для Яндекса это хорошо.\nК: То есть это лучше, да?\nМ: Ну, конечно. Чем старее домен, он...\nК: А если сайт тот говно был, извините?\nМ: Не важно, вы же сайт обновили для Яндекса, как будто, ну, оборот занялись сайтом, это хорошо, он же старый сайт не учтёт, то есть у вас будет уже новая версия, он его переиндексирует, проверит.\nК: То есть теоретически лучше купить новый старый домен, да?\nМ: Да-да, конечно, потому что он будет больше веса иметь, вот.\nК: Я понял.\nМ: Ну мы это поможем, у нас же есть специалисты, они могут это сделать.\nК: Так я вот, да, думаю что у вас всё-таки больше связи здесь.\nМ: Да-да, поэтому мы это без проблем выберем лучший вариант для этого.\nК: Добро, принято. Давайте тогда на двенадцать в понедельник связь.\nМ: Договорились, угу.\nК: Мы подготовим на выходные вопросы и запускаемся тогда, чтобы вы к маю хотя бы что-то выпустили и потом ещё...\nМ: Угу, всё.\nК: Полгода индексации вот эти.\nМ: Ну да, продвижение, ну контекст запустим сразу. Вот, я вам табличку выслал, ещё потом на встрече покажу другие месяца. Кстати, бюджет не такой большой, сто шестьдесят тысяч, клиент доволен, то есть лиды нормальные, то есть две тысячи лидов, это ну как бы дешево в вашем сегменте.\nК: Не, дело не в бюджете, мне дело в том, что хотя бы первого сентября я как-то начну получать лиды.\nМ: Так вы можете раньше контекст получать, чем у вас... летом, летом сезон.\nК: Я объясню грубо, да вы меня поймите, да, я сейчас лям морожу.\nМ: Угу, угу.\nК: И ещё получается влуплю в сайт там двести-триста рублей в месяц.\nМ: Угу.\nК: И получается ну, чек неплохой и это деньги заморожены. Поэтому хочется понимать хотя бы примерный чек выхлопа, вот я к чему. Ну, как говорится, и вариант.\nМ: Так я вам отправил девяносто видов, это было в июне, девяносто пять лидов, ну не все купили, ну вот так посчитайте, сколько у вас дверь стоит, то есть маржинальность. То есть это уже, ну, с первого месяца, по сути, можно делать, вот за сто семьдесят тысяч. Вот, поэтому из контекста результат он быстро идёт. Это же не SEO, посева, да, нужно будет ждать полгода, вот, а с контекста у вас результат пойдёт сразу, как сайт будет готов в интернете.\nК: Дай бог, дай бог.\nМ: Вот, поэтому...\nК: Добро.\nМ: Стратегия такая с вами будет, всё тогда.\nК: А я...\nМ: Что, ещё раз?\nК: Да, последний, последний вопрос.\nМ: Да.\nК: Вы как хакеры там всем сайты делаете, да? Какие перечень названий? Никаких у вас там не валяется просто сейчас, у меня тринадцать сайтов, и я что-то уже в названиях не знаю, какие названия вдумывать.\nМ: Надо подумать, почему, поможем. Ну, Екатерина, она занимается этим вопросом, как раз я ей скажу, она настоящий предложит вариант.\nК: Что реально уже тупим.\nМ: Ну, я понял, да, тяжело, тяжело придумать.\nК: Какое название, у нас там десять доменов, и получается уже вроде всё обозвали, а эти домены, чтобы вы понимали, вот даже у меня есть сайт и сайт лейдинг, и этот Авито Рус двери, блин, засранцы просто начали копировать Рус двери, а только логотип поменяли. Ну что, блин, вы такие тупые не можете придумать, я его просто придумал в прошлом, позапрошлом году, они меня начали копировать уже.\nМ: Угу, угу, у, ну, вот это да, такое бывает, к сожалению.\nК: Поэтому я хочу какое-то уникальное, которое его даже не будет и сразу нафиг его запатентовать.\nМ: Ну да, чтобы не украли.\nК: Да, чтобы никто его не копировал.\nМ: Ну, там тогда лучше вам купить несколько доменов, то есть, допустим, ну вот у двери.ру двери.рф, то есть чтобы не украли у вас название, вот, можно будет тогда сразу все вариации возможные с названием, тем более сегодня.\nК: Всё, добро, тогда во вторник, в понедельник к двенадцати, да?\nМ: А, понедельник, в понедельник свяжемся, да, Евгений, всё, если что-то поменяется, пишите, да, до свидания.\nК: Да, всё, спасибо.\n",
                "data": {
                    "categories": [
                        {
                            "id": 6,
                            "name": "Контекстная реклама новый клиент"
                        },
                        {
                            "id": 7,
                            "name": "Создание сайтов новый клиент"
                        }
                    ],
                    "criteria": [
                            {
                                "id": 1,
                                "name": "Ясность речи"
                            },
                            {
                                "id": 21,
                                "name": "Возражения"
                            }
                ]
                },
                "user_id": 1,
                "entity_id": 1
            }
        ],
        "categories": [
            {
                "id": 1,
                "name": "Продвижение сайтов новый клиент",
                "prompt": "Клиент заинтересован в услуге продвижение сайтов, однозначно подтвердил лично, что ему интересна данная услуга, из разговора следует, что у него нет действующего контракта по этой услуге, клиент общается явно с МОП",
                "criteria": [1, 2]
            },
            {
                "id": 2,
                "name": "Аренда сайтов новый клиент",
                "prompt": "Клиент заинтересован взять сайт в аренду в АдвертПро, однозначно подтвердил лично, что ему интересна данная услуга, из разговора следует, что он не арендует ни одного сайта от АдвертПро, клиент общается явно с МОП",
                "criteria": [1, 2]
            }
        ],
        "criteria": [
            {
                "id": 1,
                "group_id": 1,
                "name": "Ясность речи",
                "prompt": "Проанализируй диалог, выдели фразы менеджера и проанализируй их на ясность речи менеджера по следующим пунктам:\n- менеджер должен говорить ясно и понятно без неточностей;\n- менеджер должен использовать четкие конкретные формулировки,\n- менеджер должен использовать профессиональную терминологию, например: стратегия, видимость, пользователи, аудитория, CTR, CPC, SEO, целевая удитория, поисковая выдача, аналитика, воронка продаж, заявка, анализ конкурентов и т.д.\n- менеджер не должен использовать звуки и слова паразиты, например э-э-э, ммм, ну, вот и т.д.;\n- менеджер не должен повторять многократно одни и те же слова и словосочетания в одном предложении;\n- менеджер не должен использовать жаргон, например: текста (текст во множественном числе), контентщики, преза, сеошник, прогер, отчетик, пушить, скроллить, тормозит, тупит, прокачивать и т.д.;\nПредставь ответ единым МАРКИРОВАННЫМ списком (тире в начале пункта), где в каждом пункте идет твое резюме по каждому из указанных пунктов, и приведены примеры из текста (если примеры есть).\nСлово Менеджер не нужно употреблять в ответе, например вместо: Менеджер говорит недостаточно ясно пиши: говорит недостаточно ясно.\n",
                "show_text_description": True,
                "evaluate_criterion": True,
                "include_in_score": True,
                "include_in_entity_description": False,
                "llm_type": "standard"
            },
            {
                "id": 2,
                "group_id": 1,
                "name": "Активное слушание",
                "prompt": "Проанализируй диалог, выдели фразы менеджера и проанализируй фразы менеджера на способность активно слушать клиента по следующим пунктам:\n- менеджер должен внимательно слушать собеседника, не перебивать клиента или отвечать, не дослушав;\n- менеджер должен показывать, что слышит и понимает клиента: использовать короткие фразы согласия (понял, да, понимаю, верно, точно);\n- менеджер должен задавать уточняющие вопросы;\n- менеджер должен перефразировать слова клиента для уточнения понимания.\nПредставь ответ единым МАРКИРОВАННЫМ списком (тире в начале пункта), где в каждом пункте идет твое резюме по каждому из указанных пунктов, и приведены примеры из текста (если примеры есть).\nСлово Менеджер не нужно употреблять в ответе, например вместо: менеджер говорит недостаточно ясно пиши: говорит недостаточно ясно.\n",
                "show_text_description": True,
                "evaluate_criterion": True,
                "include_in_score": True,
                "include_in_entity_description": False,
                "llm_type": "standard"
            }
        ],
        "entities": [
            {
                "id": 1,
                "data": {}
            },
            {
                "id": 2,
                "data": {}
            }
        ]
    },
    "test": {
        "records": [
            {
                "id": "2025-01-29 16-32-34 +79067571133.mp3",
                "dialogue": "К: Алло, да.\nМ: Алло.\nК: Сбросилось. В общем, тогда завтра я вам все высылаю, списываемся, убираем время и обсуждаем. Вот уже т бизнес нет. Все, Евгений, хорошего вечера, до завтра.\nМ: Да, угу, да, да, да, да, спасибо, до завтра.\nК: До свидания.\n",
                "data": {
                    "categories": [
                        {
                            "id": 22,
                            "name": "Не определен"
                        }
                    ],
                    "criteria": []
                },
                "user_id": 1,
                "entity_id": 1
            },
            {
                "id": "2025-03-11 15-11-25 +79214078077.mp3",
                "dialogue": "М: Добрый день.\nК: Алло, здравствуйте.\nМ: Здравствуйте.\nК: Я позвонила в АдвертПро.\nМ: Да, всё верно.\nК: Попала, да, хотела бы обсудить вот продвижение сайта. С кем можно пообщаться?\nМ: Со мной. Меня Роман зовут. Как вас?\nК: Меня зовут Анна.\nМ: А.\nК: Роман, смотрите.\nМ: Да, угу.\nК: Да, ну сразу к делу.\nМ: Конечно.\nК: Да, ищем подрядчика на следующий сезон. Мы компания - производитель жидкой гидроизоляции вот, но оказываем услуги по устройству этой гидроизоляции под ключ. То есть у нас больше B2B такой сегмент получается.\nК: Вот у нас есть сайт по нашим по нашим услугам.\nМ: Угу.\nК: И есть подрядчик сейчас, который занимается SEO, то есть мы всё уже занимаемся с 2020 года, где-то на уже года четыре, наверное.\nМ: Угу, достаточно долго уже, да, так.\nК: Да, то есть ну в принципе какие-то ссылки закупаются, какие-то работы там делаются, то есть там сайт не нулевой, домен тоже там с какой-то уже с историей.\nМ: Истории, угу.\nК: Да, нужно там какая-то раз, то есть есть у него вот. Я что хотела узнать вот сейчас пока вообще просто даже первое такое приближение, сейчас подбираем подрядчика. Скажите, пожалуйста, вот у вас в среднем, да, цена за работу над сайтом, она сколько? Ну если иметь в виду, что семантическое ядро у нас ну достаточно небольшое, да, в принципе услуга одна - устройство гидроизоляции.\nМ: Угу.\nК: Вот ну и там синонимов там я не знаю, ну может быть штук там блин штук пятьдесят, наверное, максимум там.\nМ: Ну я понимаю, узкая тематика у вас, но регионы у вас по всей России?\nК: Узко, да-да.\nМ: Получается?\nК: Смотрите, региона у нас нет, у нас Москва, Московская область и ближайшие области, то есть у нас.\nМ: Ну понятно, ну угу.\nК: Ну да, да, ну скорее всего ну как бы Москва, Московская область и вот какие-то там, ну километров пятьсот, наверное, ещё.\nМ: Так.\nК: Вот, и чего ещё какая вот. Нам конечно интересно, то есть вот сейчас SEO подрядчик который у нас работает, да, он у нас штатный специалист. Проблема в чём: просто гонит нам трафик, да, то есть как бы и по трафику у нас рост как бы есть. У нас так у нас наверное в целом за год ну трафик небольшой, у нас там за год выходит где-то восемнадцать тысяч, то есть это где-то по полторы штуки на, по полторы тысячи визитов в месяц вот. То есть сейчас вот такие показатели у нас вот, но гонят в общем всякий вот шлак туда.\nМ: Угу.\nК: Вот, а роста заказов мы не видим.\nМ: Не целевой, ну понятно, понятно.\nК: Да, то есть да, то есть там по конкурентам, по каким-то вот инфоповодам туда нам туда нагоняют, типа сегодня день жестянщика, а у нас хорошие цены на там гидроизоляцию, да, вот нам вот такой вот как бы не нужно, нам лучше меньше.\nМ: Подход не нужен, угу, угу, по качеству.\nК: Да, но нам лучше больше, больше заявок. И нам конечно интересны компании, у которых есть опыт работы с такими, ну примерно с такими компаниями как мы, то есть это вот какие-то производители.\nМ: Есть, есть, да.\nК: Да, то есть не ком, а вот какие-то вот такие услуги, вот, и которые будут заинтересованы именно вот в заявках, да, нам даже не столь важны топ, какой-то позиции, да, пускай это будет.\nМ: Угу, да, мы так работаем, мы так и работаем, вот у нас есть KPI, и в вашем случае я бы ну работал по формату: абонемент и премия за именно виды вот, но.\nК: Вот, да-да-да, отлично.\nМ: Но тут есть важные нюансы: мы обычно, вы как ведёте, ну работу с клиентами, то есть у вас есть CRM или вы как в Excel ведёте, вот?\nК: Ну.\nМ: Как у вас организовано?\nК: Ну нет, да, у нас Битрикс24, мы работаем, у нас есть, да, CRM, у нас интегрирован уже растяжка знаю аналитика.\nМ: Вот-вот-вот.\nК: Снимается, да, с 2020 года, соответственно, всё предоставляем, все доступы, отчёты быть, да.\nМ: И замечательно, замечательно, вот. Ну мы в таких проектах работаем комплексно, то есть, ну я не знаю у вас это настроено, скорее всего, у вас есть интегратор какой-то, да, то есть по Битриксу, то есть кто поддержку оказывает?\nК: Ну.\nМ: Вот.\nК: Ну не совсем, у нас есть программист, который.\nМ: Свой, угу.\nК: Работает по Битриксу, вот в принципе, но это фриланс, надо понимать что нестабильный.\nМ: А у вас коробочная, у вас коробочная версия, а облачная?\nК: Облако нет, ну у нас облако, да.\nМ: Ну программист там не нужен в облаке именно конкретно. Вот смотрите, расскажу в чём суть идеи: мы являемся партнёрами Битрикса, то есть и интеграторы, и золотые партнёры, и в целом по SEO, вы нас нашли в топе. Вот, когда клиентам важны лиды, мы работаем по сквозному формату, то есть мы становимся интеграторами по Битриксу, то есть продлеваем лицензию, помогаем там либо оказываем техподдержку, как у вас программист, например, вы ему пишите наверное он там что-то делает, ну или что-то там сломалось, например, как я представлю, мы настраиваем всё, проверяем цели вот и делаем прогноз по лидам, то есть сколько лидов привлечём и план с вами согласовываем на первый месяц. Мы прогноз по лидам не делаем, потому что надо поработать с самим сайтом, вывести его на первые позиции. Вот как раз вы сказали шлей слов примерно пятьдесят запросов, правильно я понимаю? Ну такие основные для вас.\nК: Ну да, может быть даже меньше, то есть у нас вот тут в программе тот SEOшник, который работает сейчас, да, а ну у нас сайт там он посвящён услугам, но есть раздел, который продаёт сам материал, то есть если кому-то нужна эта гидроизоляция, который сам будет её наносить, мы конечно её продадим вот, и SEOшник он как раз и пытается гнать трафик вот на эту товарную страницу, а нам как бы вот.\nМ: Я понимаю, это бесполезно, это бесполезно, я понял ошибку основную, у нас подход немного другой.\nК: Да, да.\nМ: B2B сложная тематика, вот сразу говорю, поэтому тут чисто уйдёт работа на лиды, то есть первое это позиции, то что вот вы назвали, если вы не на первом месте, то по сути трафик вы теряете, ну целевой, вот именно те заказчики, которые основные. Вот мы с вами получается обговариваем вот эти цели, то есть собираем конверсию, фильтруем мусорные заявки от немусорных, нужно цели отслеживать, в том числе и почту, потому что могут писать на почту B2B закупки там и так далее вот.\nК: Угу.\nМ: И мы уже работаем конкретно на план по стоимости: абонемента он смотрите, дело в том что ссылки вообще не работают сейчас в Яндексе точно вот, поэтому то что вы закупаете ссылки это особого результата не принесёт на данный момент вот, работает поведенческий фактор вот это основное, что даёт такой быстрый результат вот, я имею в виду топ один, топ три, то есть вот самый важный запрос, потому что даже если вы сейчас уже сами в десятке, ну допустим на седьмом месте вы наверное обратили внимание сейчас много занимает реклама.\nК: Угу.\nМ: Вот и.\nК: Ну да, конечно.\nМ: Люди не листают до конца.\nК: Скоро вообще ничего не будет на первой странице, только Яндекс свой сервис.\nМ: Не, ну вряд ли, но к этому идёт, да, я понимаю о чём вы говорите, вот, то есть мы делаем под ключ SEO, то есть мы можем с вами как договориться: ну минимальный бюджет на семьдесят тысяч, это с доработками по сайту, то есть туда входят услуги там программиста.\nК: Угу.\nМ: И так далее, то есть мы сами всё делаем, то есть вот мы говорим что надо переделать страницу вот это, вот это, вот это согласовываем с вами и сами реализовываем если.\nК: Угу.\nМ: У вас есть свой программист, и вы хотите сами реализовывать, то бюджет будет там в районе пятидесяти тысяч, вот тут надо просто сравнивать, дешевле как делать через нас или чем через вашего программиста, вот плюс ещё.\nК: Ну да, да, да.\nМ: Если вам нужно какой-нибудь там баннер что-то разместить, там все хотелки есть, то есть хотелок, то есть мы тоже это делаем разумеется.\nК: Угу.\nМ: Вот, ну такие базовые вещи да, то есть.\nК: Угу.\nМ: Ну обычно выгоднее через нас делать, ну тут всё надо смотреть, сколько у вас задач обычно бывает, сколько вы платите программисту, вот по часам или там оклад вы платите, то есть надо просто сравнивать с экономическим, вот.\nК: Угу.\nМ: Что касаемо поведенческого фактора, если мы будем работать с вами по модели абонемент плюс премия за результат, то он будет входить, вот у нас есть просто абонемент с ПФ, это допустим девяносто тысяч рублей там, результат идёт практически сразу, там первый, там второй месяц, вот по SEO, но нужно чтобы была видимость, я думаю раз вы занимает четыре года SEO, вы как минимум там на первой второй странице присутствует, скорее всего под этим запросом, надо проверить их.\nК: Не факт, я говорю не факт, что она присутствуем по каким-то может быть, таким по нескольким часам может быть мы там есть, да.\nМ: Странно тогда, тогда, тогда странно очень, ну давайте как я вам в любом случае Анна напишу либо на WhatsApp там, либо на почту перейдём, вы мне вот эти запросы, которые вас интересуют, пришлёте хотя бы основные направления, мы соберём позиции ваши, да, стартовые, вот и посмотрим в чем причина, вот соответственно после первого месяца мы делаем прогнозы по лидам, беря доступа, ну можем там по Битриксу запартнериться там, посмотреть там интеграцию настроить и соответственно дальше уже план выполняем, вы оплачиваете премию, премию тоже индивидуально можем обговорить стоимость заявки, там процент выполнения плана без проблем.\nК: Угу.\nМ: Вот, с первого месяца мы так работать не можем, потому что надо понять, погрузиться в проект, вашу тематику, ну мы можем спрогнозировать какие то количество лидов исходя из вашей статистики, но это опять же будут не точные данные, вот и так же хотел уточнить, вы используете контекстную рекламу дополнительно вот, если да, то выхлоп есть от неё какой-то, вот по вашему опыту?\nК: Ну да, ну смотрите, да по контексту у нас работает другой подрядчик, то есть тут всё хорошо у нас, мы за счёт контекста, наверное, только и как бы существуем, да, потому что это реально как бы лиды.\nМ: Понял, понял, угу.\nК: Вот и ну там всё налажено.\nМ: Нет-нет-нет, я не в плане чтобы забрать ее, просто почему я спрашиваю, если он работает, какие запросы наиболее эффективные, вот, то есть мы просто возьмём эти запросы, чтобы вы с органики забирали, потому что многие вот B2B, многие закупщики им запрещено с контекста оставлять заявку, то есть им говорят надо из выдачи брать, но некоторые компании у нас такой есть примеры, потому что реклама может любой поставщик купить, да, то есть качественный он не качественный и добросовестный и недобросовестный, непонятно.\nК: Мы пока, ну да, да, да, работает, да работает, контекст работает более менее угу.\nМ: Вот, а если вы в топе, то ну к вам доверие значит больше, вот.\nК: Угу, угу.\nМ: Так, по поводу контекста, если что, если он работает хорошо, мы можем запросы просто оттуда взять и посмотреть и их продвинуть, ну как вариант.\nК: Угу.\nМ: Так, по поводу предложения тогда я вам напишу на WhatsApp, вы мне пожалуйста пришлите ссылку на сайт и приоритетные запросы, не обязательно прям пятьдесят штук, вы можете самые основные по вашему мнению, мы по ним посмотрим вот и сделаем аудит, то есть я вам подготовлю наше видение, то есть что с вашим проектом не так, ну по нашему мнению, да, вот, что мы рекомендуем сделать и условия, вот, также небольшой план работ вам предоставлю, да, на три месяца, чтобы вы могли ознакомиться.\nК: Ну это да, это понятно.\nМ: Вот.\nК: Это можете не предоставлять, тут понятно, но.\nМ: Угу.\nК: Да, нам главное вот получить какой-то хотя бы примерный, да, стоимость работ, которые у нас может получаться, вот больше в принципе ничего не интересует, потому что очень давно всё как бы все работы понятны и собственно тут как бы ну.\nМ: Тут не совсем, но видите вы, ссылки закупаете, они вообще не нужны по сути, ну то есть тут такая ситуация, SEO меняется, вот, мы два года допустим на первых позициях. Поэтому то есть у нас есть компании, которые крупнее нас, там они, там там типа Ingate, Demis Group и прочее, то есть но они не могут нас опережать, то есть потому что у них нет технологий банально современных SEO оно развивается, то есть то, что работало три года назад, оно да.\nК: Ну ладно, окей, да, да, да, да, всё, я просто очень мало времени как бы, я поняла, хорошо, давайте, всё присылайте тогда, пишите мне в WhatsApp.\nМ: Угу, да.\nК: Номер у вас определился правильно, вот я вам скину.\nМ: Да, пятьдесят тридцать три на конце, я вам сейчас всё напишу, Анна.\nК: Угу, да, да, да, да, давайте тогда это и продолжим.\nМ: Угу.\nК: Потом тогда ещё.\nМ: Всё хорошо, да, договорились.\nК: Угу, да, спасибо, угу, жду тогда, спасибо.\n",
                "data": {
                    "categories": [
                        {
                            "id": 1,
                            "name": "Продвижение сайтов новый клиент"
                        }
                    ],
                    "criteria": [
                        {
                            "id": 1,
                            "name": "Ясность речи"
                        },
                        {
                            "id": 21,
                            "name": "Возражения"
                        }
                    ]
                },
                "user_id": 1,
                "entity_id": 2
            },
            {
                "id": "2025-02-07 14-44-47 +79067571133.mp3",
                "dialogue": "К: Алло.\nМ: Два текста сейчас расскажу. Смотрите, тексты делаем мы, и они, если брать карточки, они не прям уникальные, то есть они шаблонные, как и везде. Ну, то есть именно в самих карточках, но в разделах будет уникальный текст делом. То есть мы берём у вас характеристики дверей, цены там и так далее, и загружаемые подразделы идут такие уникальные тексты. То есть любой сайт, вы дверные зайдёте, там так и сделано у всех. Может, двери, например, можете зайти, то есть вот будет примерно так же. То есть текст с нашей стороны, они будут заложены... ну, нами сделаны, а карточкой будет заниматься отдельный человек скрывался. То есть вы им будете высылать фотографии, он их будет обрабатывать, монтировать видео, вот.\nК: Я понял. Давайте на понедельник встречу к обеду сделаем.\nМ: К обеду с Екатериной. Давайте, да-да, давайте я, наверное, какого-то SEO-шника лучше ещё позову, как раз чтобы по текстам она показала, рассказала, кто людьми занимается.\nК: Да-да, не вопрос, не вопрос. Я буду как раз просто с Юлей в понедельник полдня.\nМ: Так вот, давайте секунду, двенадцать, да. Сейчас я просто по времени смотрю, так двенадцать ноль-ноль.\nК: Я думал мы как раз, давайте в двенадцать.\nМ: Давайте.\nК: Давайте, не вопрос. Просто этот, мы сейчас за выходные с ней обдумаем все-все вопросы, обдумаем ваши материалы, и...\nМ: Ну, смотрите, да-да-да, смотрите. Вот если по карточкам, получается шестьсот их максимум, да, получается даже если по четыреста будет, двести сорок тысяч вот это вот эта работа этого специалиста. Вот у нас это стоило полтора миллиона рублей, да, то есть, ну, тысяча рублей стоило. Короче, поэтому, ну, это неадекватно дорого, я понимаю. Вот поэтому вот рева нашёл, соответственно, по текстам, но это там многие тексты, они всё равно потом меняются, потому что всё же меняется, то есть там текст постоянно обновляется, то есть как бы Яндекс за этим следит. Поэтому да, приглашу, вопросы подготовить как раз к встрече, вот те которые вас волнуют, и мы всё решим в понедельник.\nК: У, да, у меня один вопрос. Я знаю на него ответ, но хочу удостовериться.\nМ: Так.\nК: Сначала как на физика, допустим, на Юлю делаем сайт, потому что на мне стоит другой сайт, да, на Юлю делаем сайт и...\nМ: Угу.\nК: Скажите мне, и после этого я сделаю как на физлицо, после этого я открою какую-то там на себя ИП дополнительную, потом вы кинете...\nМ: Ну смотрите, сайт, домен надо оформлять на физика, вот с нами договор можете хоть на юрлицо, это не важно. Ну, то есть мы с физиками не работаем.\nК: Да-да, не с вами, я с вами разберусь, мне за вас не волнует, меня волнует, могу ли я сначала просто оформить сайт как на физика, а потом как в мае месяце, когда вы скажете всё, мы готовы выпускаться, да выходить в эфир, я открываю ИП и оформляю его на ИП-шку.\nМ: А, да, сайт, да, угу, можно, можно, но только единственное что, там надо будет вы в Москве же, а вы в Клину, ну в Москву надо будет съездить с паспортом, вот там в Rek.ru, где будет домен зарегистрирован, написать заявление, что на вас переоформляется момент. Это в личной встрече надо делать.\nК: Да мне домен не надо, я именно за сам сайт спрашиваю.\nМ: Не-не-не, смотрите, объясню. Сайт не важно на кого оформлен, вот именно сам сайт это файл, то есть как папка. Вот самое важное — домен, вот потому что юридически домен считается сайтом, вот и домены должны быть на разные юрлица, чтобы продвигаться могли.\nК: Правильно, правильно, поэтому я и хочу еще открыть дополнительно.\nМ: Вот, и это домен, именно домен, поэтому я бы вообще на вашем месте не торопился с этим, то есть вы можете спокойно ИП открыть и уже домен купить на ИП, чтобы не переоформлять.\nК: Да не могу я купить домен на ИП, потому что...\nМ: Угу.\nК: Первое, ИП будет на меня, я могу это только сделать в мае.\nМ: А, понял, ну...\nК: Поэтому у меня, я уточняю. Это первое, второе, на меня уже Royal, ну мой основной сайт сделан, я не хочу делать эту индексацию, так сказать, чтоб увидели, что на мне куча сайтов, а Яндекс всё равно где-то это видит.\nМ: Ну да, это не очень хорошо, да-да-да, нельзя, нельзя так делать правильно, да.\nК: Ну так, я вот здесь и хочу, да, просто сейчас оформить на Юлю.\nМ: Без проблем, без проблем, угу.\nК: А потом просто сделать на ИП, на какую-то юридическую компанию, ну или я может найду...\nМ: Как хотите, тут можно так сделать.\nК: Найду какую-то компанию.\nМ: Без проблем. Ну, можно сайт оформлять как на физика, так и на юрика, главное, чтобы разные, ну как бы люди были.\nК: Правильно, я и вопрос здесь вот. Сначала физик, потом можно на юрик.\nМ: Можно, можно, да, но это надо будет ей лично ехать в Rek.ru там писать заявление.\nК: Вот у меня...\nМ: Переоформление.\nК: Так, опять же так и не понял, зачем писать заявление.\nМ: А это правило, то есть вы же регистрируете это, domain.ru, ну это по законодательству так вот, это собственность, это машина купили, например, она оформлена на вас.\nК: Угу.\nМ: Вот, соответственно, для того чтобы её кому-то подарить или продать, нужно тоже оформить договор передачи, вот а он только, ну как, без проблем мошенничества, потому что может мало ли там вы позвоните, скажите, представитесь Юлей и скажите, сайт мой, там типа переделайте. Им надо лично видеть, что этот человек, паспорт его, что сайт действительно, потому что вот есть пример, смотрите, вы оплачиваете домен каждый год, да, чтобы он продлевался, там какая-то сумма, если вы забудете заплатить...\nК: Угу.\nМ: Он будет в свободном плавании, и, допустим, люди могут подловить, купить его, и вам придётся у них уже выкупать. Они бывают дорого стоят, вот, есть компании, которые мониторят, чтобы домен украсть вот так, поэтому там всё серьёзно.\nК: А вопрос то у меня не в этом же был.\nМ: Ну то что можно переоформить, да можно конечно. Вопрос просто, что это не так просто сделать, не быстро это будет.\nК: Хреново.\nМ: Да нет, мы поможем, ничего страшного, такие ситуации бывают. Вот соответственно, я думаю не проблема будет делать.\nК: Ага.\nМ: Просто некоторым людям приходится из Владивостока прилетать в Москву, то есть даже такое вот.\nК: Добро, давайте.\nМ: Вы хотя бы рядом.\nК: Я понял, а скажите пожалуйста, а вы не занимаетесь, я хочу запатентовать свой старый сайт и потом, соответственно, когда вы мне выдадите его, давать еще этот новый сайт.\nМ: Угу. Я не знаю, могу уточнить у коллег, делали такое, я сейчас не сталкивался с патентами.\nК: Да, как бы я раньше...\nМ: Вот, угу.\nК: Был связан с юридическими точками, и это стоило-стоило восемнадцать тысяч в двадцать первом году.\nМ: Угу.\nК: Сам факт, что я не заморачивался, я не знаю что, ну, тонкости.\nМ: Я понял, я уточню у коллег.\nК: Поэтому, блин, вот это...\nМ: Если что, поможем, если это сделать.\nК: Беготня вот это вот, правильное оформление, вот не знаешь как правильно.\nМ: Угу, хорошо, подскажем, тогда уточню, конечно.\nК: Да, и соответственно, это дай бог, чтобы он получился всё хорошо, соответственно, его тоже патентовать.\nМ: Решим тогда.\nК: Поэтому мы сейчас с Юлей мы можем, получается, заключая с вами договор, вы начинаете делать, а потом название или здесь будет зависеть тоже сильно от домена.\nМ: Позже можно, позже. Поэтому я вам и говорю, что чисто теоретически, можете успеть на юрлицо сразу сделать, если в мае он будет готов, юрлицо откроете вот. А вы на себя как физика вы не хотите оформить. Просто какая разница? А, вы как физики были, а, уже есть. Понял, понял, хорошо, хорошо. Тогда я тогда обсудим тогда в понедельник, я ещё с Екатериной посоветуюсь.\nК: А на мне уже есть пару сайтов, да. А если получается, у меня есть домен, мы этот ваш, вы делаете на моём домене сайт.\nМ: Угу, угу.\nК: А потом в мае месяце я открываю ИП на себя.\nМ: Угу.\nК: А я регистрирую его на него и меняю название.\nМ: Угу.\nК: Новый домен это плохо, если будет новый домен.\nМ: Ну, можно, нет, почему, можно вес передать старого домена на новый, то есть вот это вес, он имеет каждый домен, ну историю, грубо говоря, то есть более старый домен они лучше прям молодых. Вот поэтому можно вес передать.\nК: Что, заморочиться?\nМ: Ну, ну мы в этом разбираемся.\nК: Заморочиться получается, может у кого-то купить домен.\nМ: Да-да, можно купить старые домены и в один их слить вес, это дроп называется, дроп замен, то есть вы покупаете, ну не знаю какой, дверь.ру, ну образно, там дверь.москва, вот, и покупаете старые домены какие-то, и просто вес их передаётся новому. Для Яндекса это хорошо.\nК: То есть это лучше, да?\nМ: Ну, конечно. Чем старее домен, он...\nК: А если сайт тот говно был, извините?\nМ: Не важно, вы же сайт обновили для Яндекса, как будто, ну, оборот занялись сайтом, это хорошо, он же старый сайт не учтёт, то есть у вас будет уже новая версия, он его переиндексирует, проверит.\nК: То есть теоретически лучше купить новый старый домен, да?\nМ: Да-да, конечно, потому что он будет больше веса иметь, вот.\nК: Я понял.\nМ: Ну мы это поможем, у нас же есть специалисты, они могут это сделать.\nК: Так я вот, да, думаю что у вас всё-таки больше связи здесь.\nМ: Да-да, поэтому мы это без проблем выберем лучший вариант для этого.\nК: Добро, принято. Давайте тогда на двенадцать в понедельник связь.\nМ: Договорились, угу.\nК: Мы подготовим на выходные вопросы и запускаемся тогда, чтобы вы к маю хотя бы что-то выпустили и потом ещё...\nМ: Угу, всё.\nК: Полгода индексации вот эти.\nМ: Ну да, продвижение, ну контекст запустим сразу. Вот, я вам табличку выслал, ещё потом на встрече покажу другие месяца. Кстати, бюджет не такой большой, сто шестьдесят тысяч, клиент доволен, то есть лиды нормальные, то есть две тысячи лидов, это ну как бы дешево в вашем сегменте.\nК: Не, дело не в бюджете, мне дело в том, что хотя бы первого сентября я как-то начну получать лиды.\nМ: Так вы можете раньше контекст получать, чем у вас... летом, летом сезон.\nК: Я объясню грубо, да вы меня поймите, да, я сейчас лям морожу.\nМ: Угу, угу.\nК: И ещё получается влуплю в сайт там двести-триста рублей в месяц.\nМ: Угу.\nК: И получается ну, чек неплохой и это деньги заморожены. Поэтому хочется понимать хотя бы примерный чек выхлопа, вот я к чему. Ну, как говорится, и вариант.\nМ: Так я вам отправил девяносто видов, это было в июне, девяносто пять лидов, ну не все купили, ну вот так посчитайте, сколько у вас дверь стоит, то есть маржинальность. То есть это уже, ну, с первого месяца, по сути, можно делать, вот за сто семьдесят тысяч. Вот, поэтому из контекста результат он быстро идёт. Это же не SEO, посева, да, нужно будет ждать полгода, вот, а с контекста у вас результат пойдёт сразу, как сайт будет готов в интернете.\nК: Дай бог, дай бог.\nМ: Вот, поэтому...\nК: Добро.\nМ: Стратегия такая с вами будет, всё тогда.\nК: А я...\nМ: Что, ещё раз?\nК: Да, последний, последний вопрос.\nМ: Да.\nК: Вы как хакеры там всем сайты делаете, да? Какие перечень названий? Никаких у вас там не валяется просто сейчас, у меня тринадцать сайтов, и я что-то уже в названиях не знаю, какие названия вдумывать.\nМ: Надо подумать, почему, поможем. Ну, Екатерина, она занимается этим вопросом, как раз я ей скажу, она настоящий предложит вариант.\nК: Что реально уже тупим.\nМ: Ну, я понял, да, тяжело, тяжело придумать.\nК: Какое название, у нас там десять доменов, и получается уже вроде всё обозвали, а эти домены, чтобы вы понимали, вот даже у меня есть сайт и сайт лейдинг, и этот Авито Рус двери, блин, засранцы просто начали копировать Рус двери, а только логотип поменяли. Ну что, блин, вы такие тупые не можете придумать, я его просто придумал в прошлом, позапрошлом году, они меня начали копировать уже.\nМ: Угу, угу, у, ну, вот это да, такое бывает, к сожалению.\nК: Поэтому я хочу какое-то уникальное, которое его даже не будет и сразу нафиг его запатентовать.\nМ: Ну да, чтобы не украли.\nК: Да, чтобы никто его не копировал.\nМ: Ну, там тогда лучше вам купить несколько доменов, то есть, допустим, ну вот у двери.ру двери.рф, то есть чтобы не украли у вас название, вот, можно будет тогда сразу все вариации возможные с названием, тем более сегодня.\nК: Всё, добро, тогда во вторник, в понедельник к двенадцати, да?\nМ: А, понедельник, в понедельник свяжемся, да, Евгений, всё, если что-то поменяется, пишите, да, до свидания.\nК: Да, всё, спасибо.\n",
                "data": {
                    "categories": [
                        {
                            "id": 6,
                            "name": "Контекстная реклама новый клиент"
                        },
                        {
                            "id": 7,
                            "name": "Создание сайтов новый клиент"
                        }
                    ],
                "criteria": [
                    {
                        "id": 1,
                        "name": "Ясность речи"
                    },
                    {
                        "id": 21,
                        "name": "Возражения"
                    }
                ]
                },
                "user_id": 1,
                "entity_id": 1
            }
        ],
        "categories": [
            {
                "id": 1,
                "name": "Продвижение сайтов новый клиент",
                "prompt": "Клиент заинтересован в услуге продвижение сайтов, однозначно подтвердил лично, что ему интересна данная услуга, из разговора следует, что у него нет действующего контракта по этой услуге, клиент общается явно с МОП",
                "criteria": [1, 2]
            },
            {
                "id": 2,
                "name": "Аренда сайтов новый клиент",
                "prompt": "Клиент заинтересован взять сайт в аренду в АдвертПро, однозначно подтвердил лично, что ему интересна данная услуга, из разговора следует, что он не арендует ни одного сайта от АдвертПро, клиент общается явно с МОП",
                "criteria": [1, 2]
            }
        ],
        "criteria": [
            {
                "id": 1,
                "group_id": 1,
                "name": "Ясность речи",
                "prompt": "Проанализируй диалог, выдели фразы менеджера и проанализируй их на ясность речи менеджера по следующим пунктам:\n- менеджер должен говорить ясно и понятно без неточностей;\n- менеджер должен использовать четкие конкретные формулировки,\n- менеджер должен использовать профессиональную терминологию, например: стратегия, видимость, пользователи, аудитория, CTR, CPC, SEO, целевая удитория, поисковая выдача, аналитика, воронка продаж, заявка, анализ конкурентов и т.д.\n- менеджер не должен использовать звуки и слова паразиты, например э-э-э, ммм, ну, вот и т.д.;\n- менеджер не должен повторять многократно одни и те же слова и словосочетания в одном предложении;\n- менеджер не должен использовать жаргон, например: текста (текст во множественном числе), контентщики, преза, сеошник, прогер, отчетик, пушить, скроллить, тормозит, тупит, прокачивать и т.д.;\nПредставь ответ единым МАРКИРОВАННЫМ списком (тире в начале пункта), где в каждом пункте идет твое резюме по каждому из указанных пунктов, и приведены примеры из текста (если примеры есть).\nСлово Менеджер не нужно употреблять в ответе, например вместо: Менеджер говорит недостаточно ясно пиши: говорит недостаточно ясно.\n",
                "show_text_description": True,
                "evaluate_criterion": True,
                "include_in_score": True,
                "include_in_entity_description": False,
                "llm_type": "standard"
            },
            {
                "id": 2,
                "group_id": 1,
                "name": "Активное слушание",
                "prompt": "Проанализируй диалог, выдели фразы менеджера и проанализируй фразы менеджера на способность активно слушать клиента по следующим пунктам:\n- менеджер должен внимательно слушать собеседника, не перебивать клиента или отвечать, не дослушав;\n- менеджер должен показывать, что слышит и понимает клиента: использовать короткие фразы согласия (понял, да, понимаю, верно, точно);\n- менеджер должен задавать уточняющие вопросы;\n- менеджер должен перефразировать слова клиента для уточнения понимания.\nПредставь ответ единым МАРКИРОВАННЫМ списком (тире в начале пункта), где в каждом пункте идет твое резюме по каждому из указанных пунктов, и приведены примеры из текста (если примеры есть).\nСлово Менеджер не нужно употреблять в ответе, например вместо: менеджер говорит недостаточно ясно пиши: говорит недостаточно ясно.\n",
                "show_text_description": True,
                "evaluate_criterion": True,
                "include_in_score": True,
                "include_in_entity_description": False,
                "llm_type": "standard"
            }
        ],
        "entities": [
            {
                "id": 1,
                "data": {}
            },
            {
                "id": 2,
                "data": {}
            }
        ]
    }
}

    updated_data = asyncio.run(analyze_criteria(data_dict_example,
                                                   max_retries=3,
                                                   retry_delay=1.0,
                                                   max_concurrent_requests=50))
    logger.debug(json.dumps(updated_data, indent=4, ensure_ascii=False))
