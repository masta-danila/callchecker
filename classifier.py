import asyncio
from functools import partial
from llm_router import llm_request
import json

PROMPT1 = """
Ты - ассистент по анализу диалогов между менеджерами компании АдвертПро и клиентами. Твоя задача - проанализировать 
разговор и определить, к каким из категорий принадлежит диалог.
Текст диалога:
"""

PROMPT2 = """
Категории для классификации представлены в виде словаря с ключом "categories", где значение - список объектов, описывающих категории:
"""

PROMPT3 = """
Ответ выдай строго в виде списка следующего синтаксиса (без доп символов и кавычек, синтаксис списка должен быть с таким 
же набором квадратных скобок и двойных кавычек, обрамлять список в доп символы запрещено):
["Категория 1", "Категория 2"]
"""


async def assign_category(text: str, categories: dict) -> dict:
    """
    Асинхронная функция, которая:
      1. Принимает text (строка с диалогом) и categories (словарь категорий в формате categories_example_new)
      2. Формирует единый запрос, состоящий из:
         PROMPT1 + текст диалога + PROMPT2 + JSON-представление словаря + PROMPT3
      3. Делает синхронный запрос через deepseek_request (через run_in_executor)
      4. Ожидает ответ, содержащий список имен выбранных категорий
      5. Находит полные объекты категорий из исходного словаря, сопоставляя их по имени, и возвращает только поля "id" и "name"
      6. Возвращает словарь с полем "categories" (список выбранных объектов) и "cost" (стоимость запроса)
    """
    loop = asyncio.get_running_loop()

    # Преобразуем словарь категорий в отформатированную строку JSON
    categories_str = json.dumps(categories, ensure_ascii=False, indent=4)

    # Формируем единый промпт
    combined_prompt = (
        f"{PROMPT1}\n{text}\n"
        f"{PROMPT2}\n{categories_str}\n"
        f"{PROMPT3}"
    )

    messages = [
        {"role": "user", "content": combined_prompt}
    ]

    # Выполняем синхронный запрос через llm
    result = await loop.run_in_executor(
        None,
        partial(llm_request,
                model="gpt-4o-mini",
                messages=messages)
    )

    # Извлекаем ответ и стоимость
    answer_text = result["content"]
    try:
        # Ожидаем, что ответ — это JSON список имен категорий, например:
        # ["Продвижение сайтов новый клиент", "Аренда сайтов новый клиент"]
        selected_names = json.loads(answer_text)
    except json.JSONDecodeError:
        selected_names = []

    # Находим полные объекты категорий, сопоставляя по полю "name" и оставляя только "id" и "name"
    selected_categories = []
    for category in categories.get("categories", []):
        if category["name"] in selected_names:
            selected_categories.append({
                "id": category["id"],
                "name": category["name"]
            })

    cost = result["cost"]

    return {"categories": selected_categories, "cost": cost}


# Пример вызова:
if __name__ == "__main__":
    text_example = """
    1: алло
    0: алло здравствуйте
    1: здравствуйте
    0: я по поводу обращаюсь по поводу создания сайтов
    1: угу
    0: скажите пожалуйста под ключ делаете
    1: да конечно вы хотите потом подвязать под все
    0: да село яндекс все под ключ на долгой основе любить друг друга многие года или как
    1: года все верно мы так и работаем в основном так берем на посев
    0: замечательно у меня металлические входные двери я хочу элитный сайт вы вывели несколько сайтов в топ десять я хочу также быть в топе десять
    1: я понял ну смотрите у вас по москве мы не сможем продвигать потому что у нас там свои сайты можем в других регионах если вы там допустим по всей россии работаете вы на москву только в основном
    0: москва московская область ну
    1: вот ну смотрите а у вас посторенный сайты вот которые в топе это наш сайт в том числе то есть они нам принадлежат а у вас только получается противопожарные да двери то есть межкомнатных нет
    0: элитные межкомнатные да межкомнатных нет только элитные то что там есть
    1: а премиум премиум коттеджи коттеджи
    0: премиум класс да да совершенно верно
    1: ну по премиум если мы вас будем именно в премиум сегменте продвигать я думаю можно потому что у нас двери сидят просто по высокочастотным то есть там ну общие хотя в коттедже тоже мы в топе я обсужу но разработка сайта вы понимаете там должен быть каталог достаточно большой или у вас на заказ какой то идет то есть какое то эксклюзивные двери можете делать ковка какая то
    0: ну эксклюзивно я могу как говорится может быть один из ваших сайтов показать да не знаю пару сайтов просто для примера дать
    1: угу
    0: и все
    1: я понял ну смотрите я это
    0: сейчас же когда я извиняюсь когда раньше делали да и я там делал первые сайты то там
    1: ага да
    0: искал а сейчас есть и пинтерест там где там тысячи моих даже дверей которых я лично делал там они уже есть поэтому сейчас уже легче
    1: ну смотрите тут вопрос в стоимости то есть у нас такие сайты там большие стоят где то от шестиста тысяч вот под разработку вот потому что там большой каталог и ну большая работа вот если брать там на битриксе сайт именно как интернет магазин под доменами в подмосковье же дома коттеджи находятся то есть надо под замены делать то есть тут полноценная работа сео потом где то в районе семидесяти ста тысяч в месяц стоит
    0: угу угу
    1: продвижение вот поэтому первый этап разработка то есть мы выбираем там структуру там отрисовку логотип ну то есть все что необходимо и уже реализовываем понимаете единственное что момент согласовать узнать можем ли мы взять вот как элитные двери потому что у нас стоп стоит набрать именно двери на продвижение по москве чтобы не конкурировать с самим собой вот я поэтому уточню но если там ритм я думаю может быть согласуют и сделаем вам смету от предложения
    0: а у вас получается вы делаете разве там нет ну не элитных грубо скажем а в коттедже те же потому что у меня так же будет и в квартиру
    1: ну кот же мы двигаем но там в основном пласта лидов там не в коттедже идет а просто вот противопожарные двери металлические входные то есть там в основном так ну я уточню вот если можем взять то
    0: да меня меня это противопожарная меня не волнует там если будет одна карточка что мы делаем пожарки и все а так меня они не волнуют меня больше волнует это коттеджи и соответственно волнует где нигде квартирки
    1: угу угу я понял я понял уточню тогда у коллег и так давайте могу вам в ватсап написать по этому номеру вот
    0: да да евгений
    1: евгений меня роман зовут вот я вам сейчас напишу и в любом случае сегодня сообщу по обратной связи
    0: да только у меня сразу
    1: да
    0: одно условие это все под ключ
    1: ну конечно конечно мы под ключ работаем то есть я вам
    0: просто да чтобы потом не было дай мне делай сео кому то просто я тоже сейчас обзваниваю они там ищи кто гирик будет делать или ищи кто кто его будет делать
    1: нет так и есть так и есть то есть мы под ключ делаем вот другие компании не могут делать как мы в большинстве своем то есть мы в дверях это ну самое мы с две тысячи шестого года людьми занимаемся вот именно как тематикой вот у нас новый проект сайтов вот поэтому я просто узнаю можно ли нельзя ли взять в работу вот если можно то я вам уже развернутое предложение подготовлю мы с вами все детали обсудим и расскажу что нужно там для начала сотрудничества
    0: ну все равно получается конкуренция она же идет какая разница кто будет создавать сайт
    1: не ну смотрите мы просто живем за счет лидов с этих дверей то есть мы продаем лиды то есть у нас сайт нам принадлежит мы вашим коллегам заявки подаем с него вот с этих сайтов которые вот вы видите в топе вот то есть мы сами себе
    0: а сколько лиды у вас стоят или вы отдельно только продаете
    1: ну москва у нас сдана полностью вот ну так в среднем наверное от четырехсот рублей где то и стоит
    0: а как записаться к вам
    1: ну
    0: на прием
    1: проблемы все занято пока то есть если там соседние какие то области можно посмотреть но опять же у вас же премиум то есть вам же не нужны все ряды там которые дешевые например ну как дешевые
    0: да почему у меня есть менеджер есть кому обрабатывать почему
    1: ну ну вряд ли просто сейчас я сам сдал сайт на прошлой неделе на прошлом месяце там на двести тысяч наверное лидов там новая мы сдали не знаю сейчас спрошу есть свободные или нет в любом случае евгений я вам сообщу вот
    0: будет обрабатывать
    1: как будет действовать
    0: да держите пожалуйста да
    1: все вот если что на связи я вам там в чат напишу вы можете тогда написать вопрос
    0: да да да спасибо буду ждать
    1: до свидания
    """
    text_example = "М: Приложение идите."

    categories_example = {
        "categories": [
            {
                "id": 1,
                "name": "Продвижение сайтов новый клиент",
                "prompt": "Клиент заинтересован в услуге продвижение сайтов, однозначно подтвердил лично, что ему интересна данная услуга, из разговора следует, что у него нет действующего контракта по этой услуге, клиент общается явно с МОП",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 2,
                "name": "Аренда сайтов новый клиент",
                "prompt": "Клиент заинтересован взять сайт в аренду в АдвертПро, однозначно подтвердил лично, что ему интересна данная услуга, из разговора следует, что он не арендует ни одного сайта от АдвертПро, клиент общается явно с МОП",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 3,
                "name": "Зарубежное продвижение сайтов новый клиент",
                "prompt": "Клиент заинтересован в услуге Зарубежное продвижение сайтов, однозначно подтвердил лично, что ему интересна данная услуга, из разговора следует, что у него нет действующего контракта по этой услуге, клиент общается явно с МОП",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 4,
                "name": "Управление репутацией SERM, ORM новый клиент",
                "prompt": "Клиент заинтересован в услуге Управление репутацией SERM, ORM, однозначно подтвердил лично, что ему интересна данная услуга, из разговора следует, что у него нет действующего контракта по этой услуге, клиент общается явно с МОП",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 5,
                "name": "Продвижение в Яндекс Картах новый клиент",
                "prompt": "Клиент заинтересован в услуге Продвижение в Яндекс Картах, однозначно подтвердил лично, что ему интересна данная услуга, из разговора следует, что у него нет действующего контракта по этой услуге, клиент общается явно с МОП",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 6,
                "name": "Контекстная реклама новый клиент",
                "prompt": "Клиент заинтересован в услуге Контекстная реклама, однозначно подтвердил лично, что ему интересна данная услуга, из разговора следует, что у него нет действующего контракта по этой услуге, клиент общается явно с МОП",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 7,
                "name": "Создание сайтов новый клиент",
                "prompt": "Клиент заинтересован в услуге Разработка сайтов, однозначно подтвердил лично, что ему интересна данная услуга, из разговора следует, что у него нет действующего контракта по этой услуге, клиент общается явно с МОП",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 8,
                "name": "Техническая поддержка сайтов новый клиент",
                "prompt": "Клиент заинтересован в услуге Техническая поддержка сайтов, однозначно подтвердил лично, что ему интересна данная услуга, из разговора следует, что у него нет действующего контракта по этой услуге, клиент общается явно с МОП",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 9,
                "name": "Веб-аналитика новый клиент",
                "prompt": "Клиент заинтересован в услуге Веб-аналитика, однозначно подтвердил лично, что ему интересна данная услуга, из разговора следует, что у него нет действующего контракта по этой услуге, клиент общается явно с МОП",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 10,
                "name": "Внедрение CRM Битрикс 24 новый клиент",
                "prompt": "Клиент заинтересован в услуге Внедрение CRM Битрикс 24 (хочет, чтобы ему настроили CRM Битрикс 24), однозначно подтвердил лично, что ему интересна данная услуга, из разговора следует, что у него нет действующего контракта по этой услуге, клиент общается явно с МОП",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 11,
                "name": "Продвижение сайтов текущий клиент",
                "prompt": "Клиент общается по услуге Продвижение сайтов, очевидно, что у него есть действующий контракт по этой услуге и клиент общается явно с аккаунт-менеджером",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 12,
                "name": "Аренда сайтов текущий клиент",
                "prompt": "Клиент общается по поводу сайта в аренду, который он уже арендует в АдвертПро, и он общается с аккаунт-менеджером компании АдвертПро",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 13,
                "name": "Зарубежное продвижение сайтов текущий клиент",
                "prompt": "Клиент общается по услуге Зарубежное продвижение сайтов, очевидно, что у него есть действующий контракт по этой услуге и клиент общается явно с аккаунт-менеджером",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 14,
                "name": "Управление репутацией SERM, ORM текущий клиент",
                "prompt": "Клиент общается по услуге Управление репутацией SERM, ORM, очевидно, что у него есть действующий контракт по этой услуге и клиент общается явно с аккаунт-менеджером",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 15,
                "name": "Продвижение в Яндекс Картах текущий клиент",
                "prompt": "Клиент общается по услуге Продвижение в Яндекс Картах, очевидно, что у него есть действующий контракт по этой услуге и клиент общается явно с аккаунт-менеджером",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 16,
                "name": "Контекстная реклама текущий клиент",
                "prompt": "Клиент общается по услуге Контекстная реклама, очевидно, что у него есть действующий контракт по этой услуге и клиент общается явно с аккаунт-менеджером",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 17,
                "name": "Создание сайтов текущий клиент",
                "prompt": "Клиент общается по услуге Разработка сайтов, очевидно, что у него есть действующий контракт по этой услуге, сайт на стадии разработки, и клиент общается явно с аккаунт-менеджером",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 18,
                "name": "Техническая поддержка сайтов текущий клиент",
                "prompt": "Клиент общается по услуге Техническая поддержка сайтов, очевидно, что у него есть действующий контракт по этой услуге и клиент общается явно с аккаунт-менеджером",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 19,
                "name": "Веб-аналитика текущий клиент",
                "prompt": "Клиент общается по услуге Веб-аналитика, очевидно, что у него есть действующий контракт по этой услуге и клиент общается явно с аккаунт-менеджером",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 20,
                "name": "Внедрение CRM Битрикс 24 текущий клиент",
                "prompt": "Клиент общается по услуге Внедрение Битрикс 24, очевидно, что у него есть действующий контракт по этой услуге, идет рабочее согласование по настройке Битрикс 24, и клиент общается явно с аккаунт-менеджером",
                "criteria": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]
            },
            {
                "id": 21,
                "name": "Спам",
                "prompt": "Диалог не относится ни к одной категории (кроме не определен), менеджеру АдвертПро звонят из другой компании и предлагают заказать какие-то услуги, менеджер отказывается от предложения",
                "criteria": []
            },
            {
                "id": 22,
                "name": "Не определен",
                "prompt": "Диалог не принадлежит ни к одной категории, этот пункт нельзя выбирать совместно с другими категориями",
                "criteria": []
            }
        ]}

    # Запуск асинхронной функции
    result_sample = asyncio.run(assign_category(text_example, categories_example))
    print(json.dumps(result_sample, indent=4, ensure_ascii=False))