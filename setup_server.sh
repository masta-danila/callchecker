#!/bin/bash

# Server Setup Script for Callchecker
# Ð—Ð°Ð¿ÑƒÑÐºÐ°Ð¹Ñ‚Ðµ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ root: sudo ./setup_server.sh

set -e  # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð¿Ñ€Ð¸ Ð»ÑŽÐ±Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐµ

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ†Ð²ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ð²Ñ‹Ð²Ð¾Ð´Ð°
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ñ‚Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¾Ñ‚ root
if [ "$EUID" -ne 0 ]; then
    log_error "Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ root!"
    log_info "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ: sudo ./setup_server.sh"
    exit 1
fi

log_info "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð° Ð´Ð»Ñ Callchecker..."

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
log_info "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
apt update
apt upgrade -y

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
log_info "ðŸ“‹ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
apt install -y \
    curl \
    wget \
    git \
    htop \
    tree \
    nano \
    unzip \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker
log_info "ðŸ³ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker..."
if ! command -v docker &> /dev/null; then
    # Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ GPG ÐºÐ»ÑŽÑ‡Ð° Docker
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    
    # Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Docker
    echo \
        "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
        $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
    
    # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Engine
    apt update
    apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
    
    # Ð—Ð°Ð¿ÑƒÑÐº Ð¸ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Docker
    systemctl start docker
    systemctl enable docker
    
    log_success "Docker ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½!"
else
    log_info "Docker ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
USERNAME="callchecker"
if id "$USERNAME" &>/dev/null; then
    log_info "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ $USERNAME ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
else
    log_info "ðŸ‘¤ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ $USERNAME..."
    useradd -m -s /bin/bash "$USERNAME"
    
    # Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ docker
    usermod -aG docker "$USERNAME"
    
    log_success "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ $USERNAME ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ docker"
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ SSH ÐºÐ»ÑŽÑ‡ÐµÐ¹ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
CALLCHECKER_HOME="/home/$USERNAME"
if [ ! -f "$CALLCHECKER_HOME/.ssh/id_rsa" ]; then
    log_info "ðŸ”‘ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ SSH ÐºÐ»ÑŽÑ‡ÐµÐ¹ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ $USERNAME..."
    sudo -u "$USERNAME" mkdir -p "$CALLCHECKER_HOME/.ssh"
    sudo -u "$USERNAME" ssh-keygen -t rsa -b 4096 -f "$CALLCHECKER_HOME/.ssh/id_rsa" -N ""
    chmod 700 "$CALLCHECKER_HOME/.ssh"
    chmod 600 "$CALLCHECKER_HOME/.ssh/id_rsa"
    chmod 644 "$CALLCHECKER_HOME/.ssh/id_rsa.pub"
    chown -R "$USERNAME:$USERNAME" "$CALLCHECKER_HOME/.ssh"
    log_success "SSH ÐºÐ»ÑŽÑ‡Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹"
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
WORK_DIR="/home/$USERNAME/callchecker"
if [ ! -d "$WORK_DIR" ]; then
    log_info "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐ¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸..."
    sudo -u "$USERNAME" mkdir -p "$WORK_DIR"
    log_success "Ð Ð°Ð±Ð¾Ñ‡Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°: $WORK_DIR"
fi

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° firewall (UFW)
log_info "ðŸ”¥ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð»Ð°..."
if command -v ufw &> /dev/null; then
    ufw --force enable
    
    # Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ SSH
    ufw allow ssh
    
    # Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ HTTP/HTTPS (ÐµÑÐ»Ð¸ Ð¿Ð»Ð°Ð½Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ)
    ufw allow 80/tcp
    ufw allow 443/tcp
    
    # PostgreSQL Ð¸ Redis Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹
    ufw allow from 127.0.0.1 to any port 5432
    ufw allow from 127.0.0.1 to any port 6379
    
    log_success "Ð¤Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð» Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
else
    log_warning "UFW Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð» Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
fi

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð»Ð¾Ð³Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸Ð¸
log_info "ðŸ“„ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸Ð¸ Ð»Ð¾Ð³Ð¾Ð²..."
cat > /etc/logrotate.d/callchecker << EOF
/home/callchecker/callchecker/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0644 callchecker callchecker
    copytruncate
}
EOF
log_success "Ð Ð¾Ñ‚Ð°Ñ†Ð¸Ñ Ð»Ð¾Ð³Ð¾Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ° Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ° (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
log_info "âš™ï¸  Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°..."
cat > /etc/systemd/system/callchecker.service << EOF
[Unit]
Description=Callchecker Application
After=docker.service
Requires=docker.service

[Service]
Type=oneshot
RemainAfterExit=true
WorkingDirectory=/home/callchecker/callchecker
ExecStart=/usr/bin/docker compose up -d
ExecStop=/usr/bin/docker compose down
User=callchecker
Group=callchecker

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
log_success "Systemd ÑÐµÑ€Ð²Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½ (Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½)"

# Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¸
log_success "ðŸŽ‰ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo
log_info "ðŸ“‹ Ð§Ñ‚Ð¾ Ð±Ñ‹Ð»Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾:"
echo "  âœ… Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"
echo "  âœ… Docker ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
echo "  âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ '$USERNAME' ÑÐ¾Ð·Ð´Ð°Ð½"
echo "  âœ… SSH ÐºÐ»ÑŽÑ‡Ð¸ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹"
echo "  âœ… Ð Ð°Ð±Ð¾Ñ‡Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°: $WORK_DIR"
echo "  âœ… Ð¤Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð» Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
echo "  âœ… Ð Ð¾Ñ‚Ð°Ñ†Ð¸Ñ Ð»Ð¾Ð³Ð¾Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°"
echo "  âœ… Systemd ÑÐµÑ€Ð²Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½"
echo
log_info "ðŸ”„ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
echo "  1. ÐŸÐµÑ€ÐµÐ·Ð°Ð¹Ð´Ð¸Ñ‚Ðµ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ Ð¸Ð»Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ: newgrp docker"
echo "  2. ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÐµÑÑŒ Ð½Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ callchecker: su - callchecker"
echo "  3. ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð² $WORK_DIR"
echo "  4. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ env.production Ñ Ð²Ð°ÑˆÐ¸Ð¼Ð¸ ÐºÐ»ÑŽÑ‡Ð°Ð¼Ð¸"
echo "  5. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: ./deploy_production.sh"
echo
log_info "ðŸ”§ Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "  ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ: systemctl enable callchecker"
echo "  Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ°:          systemctl start callchecker"
echo "  Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐµÑ€Ð²Ð¸ÑÐ°:          systemctl status callchecker"
echo "  ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²:     htop"
echo "  ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¸ÑÐºÐ¾Ð²Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð°: df -h"
echo
log_success "âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð³Ð¾Ñ‚Ð¾Ð² Ð´Ð»Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ Callchecker!"
