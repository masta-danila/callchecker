import asyncio
import json
from functools import partial
from llm_router import llm_request

# Пояснение
PROMPT1 = """
Тебе предоставлен транскрипт разговора менеджера с клиентом. Менеджер обозначен буквой М, а клиент буквой К. ВНИМАНИЕ! 
Не спутай фразы менеджера и клиента.
"""
# PROMPT2 всегда включается в запрос
PROMPT2 = """
Ответ выдай строго в виде словаря следующего синтаксиса (без доп символов и кавычек, синтаксис словаря должен быть с 
таким же набором фигурных скобок и двойных кавычек, обрамлять словарь в доп символы запрещено):
{"text": "ответ на промпт", "evaluation": оценка по шкале от 1 до 100 в рамках промпта} 
Если в основном ответе ты не нашел никакой информации, то ставь оценку null. Оценка ставится только в ключе evaluation, в ключе text оценки ставить запрещено.
Кроме словаря вставлять что-то в ответ запрещено.
Кавычки внутри значения ключа text обязательно экранируй.
"""


async def process_client_data(dialogue: str, data: dict) -> dict:
    """
    Асинхронная функция, принимающая на вход словарь формата:
    {
        "id": <число>,
        "group_id": <число>,
        "name": <текст>,
        "prompt": <текст>,
        "show_text_description": <bool>,
        "evaluate_criterion": <bool>,
        "include_in_score": <bool>,
        "include_in_entity_description": <bool>,
        "llm_type": <строка>
    }

    Логика работы:
      - Если оба флага "show_text_description" и "evaluate_criterion" равны False, то запрос к ChatGPT не выполняется,
        а возвращается словарь с пустым текстом и оценкой None.
      - В противном случае:
          - Формируется prompt из PROMPT1, содержимого поля "prompt", текста диалога и всегда добавляется PROMPT2.
          - Отправляется запрос к ChatGPT.
          - Ответ парсится как JSON-словарь вида {"text": "...", "evaluation": ...}.
          - Если в ответе evaluation не None, то, если evaluate_criterion == True, делится значение на 20 и округляется до одной десятичной.
      - После получения ответа:
          - Если "show_text_description" == False, итоговый "text" заменяется на пустую строку.
          - Если "evaluate_criterion" == False, итоговая "evaluation" заменяется на None.
      - Возвращается словарь, содержащий только ключи "text" и "evaluation".
    """
    show_text = data.get("show_text_description", False)
    eval_crit = data.get("evaluate_criterion", False)

    # Если оба флага False, запрос не выполняется.
    if not show_text and not eval_crit:
        return {"text": "", "evaluation": None}

    description = data.get("prompt", "")
    prompt = f"{PROMPT1}{description}\nТекст диалога:{dialogue}{PROMPT2}"
    # print(prompt)  # Отладочный вывод отключен

    messages = [
        {"role": "user", "content": prompt}
    ]

    loop = asyncio.get_running_loop()
    # Выполняем блокирующий вызов в отдельном потоке через run_in_executor
    response = await loop.run_in_executor(
        None,
        partial(llm_request,
                model="gpt-5-nano",
                messages=messages)
    )

    response_content = response.get("content", "")
    try:
        parsed_json = json.loads(response_content)
    except json.JSONDecodeError as e:
        print(f"Ошибка при парсинге JSON: {e}")
        print(f"Содержимое response_content: {response_content}")
        raise

    text = parsed_json.get("text")
    eval_raw = parsed_json.get("evaluation")

    if eval_raw is not None and eval_crit:
        eval_raw = round(float(eval_raw) / 20, 1)

    if not show_text:
        text = ""
    if not eval_crit:
        eval_raw = None

    return {"text": text, "evaluation": eval_raw}


# Примеры использования:
if __name__ == "__main__":
    example_data = {
        "id": 12,
        "group_id": 2,
        "name": "Подведение итогов",
        "prompt": """
  Проанализируй диалог и определи, есть ли в диалоге возражения клиента.\n
  ВАЖНЫЕ ключевые моменты определения возражения и его отличия от потребности или боли:\n
  - ГЛАВНОЕ: возражение это исключительно НЕГАТИВНАЯ реакция на предложение МЕНЕДЖЕРА. Любые реакции, например: на текущую ситуацию у клиента, ситуацию с другими подрядчиками, потребности, боли клиента и т.д. возражениями не являются.\n
  - к возражениям можно отнести: сомнения, опасения, отговорки или аргументы клиента против предложенного МЕНЕДЖЕРОМ решения, продукта, услуги, условий, стоимости, сроков выполнения работ и т.д.\n
  Сформулируй возражения максимально кратко, но при этом понятно.\nЕсли реальных возражений нет, не давай никаких объяснений, укажи в ответе дословно: Возражений нет.\n
  Не дублируй возражения и не делай похожих по смыслу возражений. Возражения, относящиеся к одной категории объединяй в одно возражение.\n
  Если нужно упомянуть компанию клиента или компанию менеджера, указывай клиент и менеджер, чтобы не было путаницы какая компания кому принадлежит.\n
  Не используй ничего не значащие обороты, типа на настоящий момент, в настоящее время и прочее.\n
  Сокращай слова и словосочетания в тексте по общепринятым стандартам сокращений. Используй официальные правила сокращений, принятые в русском языке.\n
  Представь возражения единым МАРКИРОВАННЫМ списком (тире в начале пункта). После каждого возражения на той же строке приведи, как его отработал менежер, если не отработал, укажи, что возражение не отработано.\n
        """,
        "show_text_description": True,
        "evaluate_criterion": True,
        "include_in_score": True,
        "include_in_entity_description": False,
        "llm_type": "standard"
    }
#     example_data = {
#         "id": 12,
#         "group_id": 2,
#         "name": "Подведение итогов",
#         "prompt": """
#   Ты специалист по анализу диалогов на предмет болей, возражений и потребностей клиента. Проанализируй диалог и определи, есть ли в диалоге возражения клиента.\n
#   Сформулируй возражения максимально кратко, но при этом понятно.\nЕсли реальных возражений нет, не давай никаких объяснений, укажи в ответе дословно: Возражений нет.\n
#   Не дублируй возражения и не делай похожих по смыслу возражений. Возражения, относящиеся к одной категории объединяй в одно возражение.\n
#   Если нужно упомянуть компанию клиента или компанию менеджера, указывай клиент и менеджер, чтобы не было путаницы какая компания кому принадлежит.\n
#   Не используй ничего не значащие обороты, типа на настоящий момент, в настоящее время и прочее.\n
#   Сокращай слова и словосочетания в тексте по общепринятым стандартам сокращений. Используй официальные правила сокращений, принятые в русском языке.\n
#   Представь возражения единым МАРКИРОВАННЫМ списком (тире в начале пункта). После каждого возражения на той же строке приведи, как его отработал менежер, если не отработал, укажи, что возражение не отработано.\n
#         """,
#         "show_text_description": True,
#         "evaluate_criterion": True,
#         "include_in_score": True,
#         "include_in_entity_description": False,
#         "llm_type": "standard"
#     }
    sample_dialogue1 = """
К: Алло.
М: Алло, Влад, здравствуйте, Юлия.
К: Здравствуйте.
М: Так, смотрите, я по поводу таблицы ответила вам, будем такие таблицы использовать, когда у нас будет дооптимизация, чтобы был сразу старый текст видно и новый с теми вхождениями, которые будем использовать. По поводу калькулятора: что именно хотите обсудить? Я посмотрела все эти сайты.
К: Так, ага.
М: Которые вы мне скинули, что на одной странице и калькулятор, и таблицы.
К: Нет, это вы скинули, это вы скинули. Вот я вам из тех, которые вы скинули, там три там, где калькулятор и цены.
М: Угу.
К: Но я как бы не против, если они на разных страницах, если это нужно.
М: Лучше сделать на разных, для того чтобы у нас с вами шли запросы, допустим, по калькулятору шли запросы именно на калькулятор, по стоимости у нас шли запросы именно на стоимость. Мы так можем более релевантный URL сделать, и это будет лучше выглядеть.
К: А вы страницу с тарифами — туда икса и так далее для оптимизации — когда добавите?
М: Так, на какую страницу с тарифами?
К: Да, мы с вами обсуждали, по-моему, неделю назад, вот в чате.
М: Ну, смотрите, мы ее…
К: Что ее надо, ну, то есть задачу ее оптимизировать, потому что мы ее добавили как бы, и вот эта задача в прошлом месяце стояла.
М: Нет, подождите, страница со стоимостью услуг вы имеете в виду?
К: Нет, тарифы, тарифы. Вот калькулятор тарифа мы должны были добавить ещё в прошлом месяце и создать его, оптимизировать под SEO. Но я же с вами разговаривал, или я с кем разговаривал по этому поводу?
М: Вы со мной разговаривали по этому поводу, у нас с вами вот…
К: Ну всё, отлично, мы с вами помним, что…
М: В этом месяце…
К: Вы должны были их создать, но я вам сказал, что давайте мы сами сделаем, потому что долго будет объяснять, как делать калькулятор.
М: Угу.
К: Мы поэтому перенесли эту работу, ну, то есть работа по созданию калькулятора, мы переименовали в написание ТЗ для калькулятора.
М: Угу, угу.
К: Соответственно, вы его написали, вот мы его сейчас создали, и, соответственно, мы ожидаем, что вы его…
М: И мы его…
К: Добьёте, сделаете там всё, текст и так далее, чтобы она начала индексироваться правильно.
М: В этом месяце мы его доделаем, до конца этого месяца он будет доделан.
К: Вот, всё супер, вот это я и спрашиваю.
М: Я просто не сразу поняла, какой именно тариф страницы, смотрите, мы эту страницу переименовали в «Онлайн калькулятор стоимости услуг».
К: Да, да.
М: Она у нас с вами имеет URL калькулятор, то есть, соответственно, все ключевые слова, которые у нас есть в семантическом ядре, которые содержат слово «калькуляторы», они будут идти на эту страницу.
К: Угу.
М: А на «Стоимость услуг», где мы будем размещать таблицу, здесь уже, соответственно, будет…
К: Угу.
М: Будут сюда вести все ключи, которые содержат «стоимость услуг».
К: Текст вы добавите в этот калькулятор?
М: Да, конечно.
К: На страничку, хорошо.
М: Они уже в написании, да.
К: Всё отлично, отлично. Так, по поводу вида таблички давайте обсудим. Смотрите, что не нравится в том, что вот вы пример предоставили, сейчас я по ссылке перейду.
М: Угу.
К: Минутку, ну вот эта табличка…
М: Ну вот, смотрите, если сейчас перейти по ссылке, там красная шапочка.
К: Даже…
М: Красная шапка будет у этой таблицы, и будет всё сделано в…
К: Да, это не очень…
М: Стилях.
К: Она очень сильно внимание отвлекает, да не подходит, тем более вы сделали её очень такой яркой, короче, это не подойдёт. А вот второе в виде таблицы ещё более-менее, но вы там как бы, ну, отступы не этот, не делается, соответственно, между текстами тексты какие-то непонятные. Вот какая-то ставка такая типа «Ниже представлен прайс на бухгалтерское обслуживание ООО» — это какой-то SEO текст, но его надо грамотно вписать в общий вид и, соответственно, сделать отступы между тарифами, чтобы это читалось не одним блоком шло.
М: Угу.
К: Потом ну как-то отцентровать. Вот почему у вас ведение бухгалтерского учета — одна таблица с одной центровкой, а, например, «прейскурант на бухгалтерское сопровождение» — с другой центровкой.
М: Тут нулевое…
К: Нет, от центровки. От нулевое обслуживание, например, оно начинается…
М: Угу.
К: С того же места, где цены начинаются, а это же заголовок, наверное, ну…
М: А здесь везде заголовки начинаются с того места, где цены начинаются.
К: Пани, почему?
М: Ну вот, получается, оно не отцентровано, а выровнено всё по левому краю, смотрите, здесь поняла с центровкой.
К: Я вам не могу дать, смотрите, я вам не могу дать конкретные рекомендации, по-моему, по поводу этой таблицы, потому что в целом вся таблица она как бы, ну такая…
М: Поняла.
К: Как бы её давайте лучше примеры посмотрим, что может подойти, сейчас я открою.
М: Угу, давайте.
К: Вот, например, первый «Нумерус», отличная табличка, в чём проблема, например, так сделать — вот это и интересно, она…
М: Так, номер…
К: Она читается.
М: Угу.
К: Вот, давайте дальше посмотрим, так, здесь, ну, вот даже вот этот «Амбер ЛТД» читается, хорошая табличка, много там разных табличек, как раз-таки всё отцентровано, все отступы нужные есть.
М: Угу.
К: Заголовки нужные есть, так, так, ну всё остальное то как акцента сейчас ещё посмотрю.
М: Ну вот, смотрите, тот сайт, который вы мне прислали, который один с…
К: Нет, нет, там не очень меньше.
М: Нет.
К: Нет, вот эти два вот нормальные вот, ну, вирус нормальный и…
М: Который номер…
К: Амбера ТД.
М: Угу, так, смотрите, ну вот у нас получается, у «Нумеруса» у него фон сайта сам серый, а подложка под таблицей белая, мы можем с вами сделать наоборот: у нас с вами фон сайта белый, а мы можем взять подложку из…
К: Да, да.
М: Нашей стандартной темы, где у нас полосочками, полосочка светлая, полосочка потемнее, то есть будет одна часть, одна строка в таблице будет белая, вторая строка в таблице будет серая, чтобы это выделялось.
К: А ты где есть пример?
М: А это у нас с вами по стандартной теме, вот если зайти, если зайти по ссылке…
К: Да, окей, окей, ну вы опять полосочки хотите сделать, а вы табличку делаете у вас здесь табличка…
М: А полностью под таблицей сделать серую подложечку.
К: А не полосочки. Нет, это один из вариантов, вот, например, вамбер ПД, вот смотрите, там…
М: Угу.
К: Тоже сделано. Ну, там вот примерно как у нас сейчас сделано, то есть строками не таблицы, но там всё отцентровано, всё красиво.
М: Угу.
К: Всё выделено, шрифты выделены, где надо жирным, где надо подкрашенным.
М: Угу.
К: Ну, вот это вот два примера нормального, то что как бы, ну, не выколи глаз.
М: Хорошо, я поняла, на что нам ориентироваться, я поняла, на что нам ориентироваться. Тогда берём в доработку, сделаем также на тесте, и после этого пришлём.
К: Нет, а вы скажите, пожалуйста, а вы же принимали как бы эту работу, а вам самим нравится такая табличка?
М: Я ещё ничего не принимала, мне нужно понять, как вы видите эту таблицу. Мы сделали два примера…
К: Вот, которую они сделали…
М: Допустим…
К: Угу.
М: Для того чтобы показать вам, как можно сделать дальше, это дальше…
К: Ну, я понял, ну не так нельзя сделать.
М: Нет, так нельзя сделать, поэтому я пришла к вам, мы с вами согласовываем, я теперь получила от вас обратную связь, у меня теперь есть два референса, как вы бы это хотели видеть, и я возвращаю это в доработку, мы дорабатываем на тесте, потом выкатываем на…
К: Угу, да. Ну, как бы смотрите, как я хотел видеть, я же тоже как бы, ну, не дизайнер, то есть я вот два примера увидел, которые вы прислали, говорю вот это нормально, вот это нормально. А может есть ещё как-то это лучше сделать, поэтому и спрашиваю, у вас есть кто-то с пониманием дизайна UX, который может нормально, красиво страничку сделать? Ну, мне не жалко, давайте потратимся денег, наймём как дизайнера, не знаю, ни фрилансера, заплатите ему десять тысяч рублей, сделал классную страничку.
М: Давайте я тогда уточню по дизайнеру, если мы привлекаем дизайнеров, сколько это будет стоить, и по этой дополнительной информации уже к вам вернусь. Потому что как раз, наверное, если UX дизайнер, то действительно это придётся нанимать человека, который на фрилансе находится, вот, потому что у нас дизайнеры есть, но…
К: Но они вот это только могут сделать, что ли?
М: Нет, это сделано в стилистике сайта, это сделано программистом.
К: А, ну вот, а вы можете своего хотя бы подключить, хотя бы с базовым пониманием, или вкуса?
М: Угу.
К: Просто подключите своего и всё. Ну как бы, если уж он не справится, ну, будем не знаю, вынимать со стороны кого-то.
М: Хорошо. Так, ещё какие-то вопросы или что-то, уточнения какие-то есть?
К: Нет, по тексту сейчас прибегаешь, я говорю, половину где-то пробежался.
М: Нет? Угу, угу, хорошо. И в план внесла как раз работы по восстановлению бэкапа и плана, ну по калькулятору у нас это и так с вами есть в плане, единственное что, вот ждём тексты от копирайтера, который напишет текст для страницы с калькулятором.
К: Ну, давайте посмотрим сейчас по плану августа, что реализовано там, то ли мене плана по отзывам.
М: Так, давайте.
К: Вы всё разместили уже в этом месяце?
М: Нет, в этом месяце ещё не всё разместили. Попрошу, чтобы или сегодня, или завтра, ой, или в понедельник обновили статус выкладки, потому что когда всё ушло на размещение, появились статусы о том, что очереди на размещение, и после больше этого не актуализировались статусы, по отзывам. Так…
К: Так, сейчас минутку, отчёт по актуализации семантической, говорю, открою, у меня доступа нет.
М: Угу.
К: То, что дать.
М: Так, отчёт по актуализации…
К: Так, а мы со страницы какие создали или не создали, вот здесь реализовано написано?
М: Открыла, создали. У нас с вами в этом месяце создание страницы по ИП — она создана, добавлена в карту сайта и сейчас…
К: Ага…
М: Ну мы с вами на неё тексты согласовывали. Страницы созданы, сейчас единственное у нас находится в реализации после согласования.
К: Ага.
М: Линковка, там просто контент-менеджером не получилось данной работы сделать, это перевели на тех-отдел. Эти работы по окончанию также вам направлю, чтобы вы посмотрели, как получилось.
К: Так, а отчёт по…
М: Настройке…
К: Актуализации семантического ведра? А вы под отчётом актуализации семантического ведра представляли себе просто, что ли, это его размещение типа в этом?
М: Ну провели приоритизацию, заново залили все запросы в Ворд…
К: Ага.
М: Топвизор. Ну, в принципе, это вы могли видеть уже после того, как я вам ссылки направляла с Топвизора.
К: Так, понятно. А по поводу динамики, в целом падает она?
М: Она у нас с вами не падает, она у нас с вами пока что не стабилизировалась, потому что вот сегодня мы запросы… мы сняли позиции по ядру, и сегодня общее ядро у нас…
К: Угу.
М: Тридцать, тридцать процентов в топ десять, и по приоритетному ядру тоже тридцать запросов в топ десять. Сейчас я вам ссылку направлю с актуальными позициями.
К: Давайте, давайте, сейчас открою.
М: Вот, пока не поймем, почему качает. Ну, точнее как не поймем, мы понимаем, почему качает, потому что не хватает дооптимизации. Как раз для того, чтобы дооптимизировать страницы и напомнить их ключевыми словами, написали, ну переписали, дополнили тексты. Сейчас ключевые слова внесем на страницы и отправим сайт на переиндексацию для того, чтобы она прошла как можно скорее, после этого будем дальше смотреть динамику, будет ли хватать текущей дооптимизации. Потому что взять, например, те самые ключи, которые вот у нас с вами в приоритете, «бухгалтер» сейчас прям вот, вчера мы разбирали буквально, есть ключи, которые очень сильно шатаются со стороны в сторону, то на двадцать третьей позиции, то на девятой, то на двенадцатую скатывается. Это действительно говорит о том, что самой странице не хватает ключевых вхождений для того, чтобы занять стабильную позицию в топе выдачи.
К: Угу.
М: Вот сейчас…
К: Это да, вот сейчас со второй на двадцать четвертую, например.
М: Ну вот, это с этим и связано. Иногда бывает такое, что поисковая система, допустим, вместо «бухгалтерские услуги для ИП» считает более релевантной страницей «бухгалтерский…»
К: Ушло.
М: Учёт для ИП или допустим ещё куда-то перекидывает. Нам нужно найти оптимальное количество вхождений, которое будет размещено на странице, чтобы страница заняла стабильную позицию, и поисковая система наши ключевые запросы не перекидывала на другие страницы.
К: А вы можете в отдельную группу вывести ключевики, которые у нас должны быть в топе за август? У нас же там три месяца, по-моему, август, сентябрь и октябрь, да?
М: Нет, у нас с вами там сентябрь, октябрь и…
К: Мы можем с вами…
М: Декабрь, по-моему, или ноябрь, вот здесь вот точно…
К: Окей, окей.
М: Не вспомню.
К: Вот вы можете в отдельной вывести, сентябрь, октябрь, ноябрь, вот эти, ну, группы вот эти создать, чтобы я мог, например, там септябрь — это такой цвет, это такой цвет, это такой, чтобы мы по месяцам посмотрели.
М: Угу, да, хорошо.
К: Потому что я сейчас смотрю, например, вижу, что какие-то двадцать четвёртое, девяносто пятый, и общее впечатление остался как будто мы не идём, а на самом деле мы там ничего не делаем по ним пока, потому что у нас другие приоритеты. Вот, можете нам сгруппировать их по месяцам?
М: Хорошо, да, хорошо, давайте сгруппируем по месяцам, тегами выделим, также через цвета.
К: То есть зелёная — это пусть будет общая…
М: Угу.
К: Да, и ещё три цвета — это вот эти месяцы, по которым мы должны идти.
М: Угу, хорошо, хорошо, давайте сделаем.
К: У нас же это в этой табличке, по-моему, сейчас я открою её, по этому, да, в плане где-то у нас должно быть…
М: Да, это у нас в полезных ссылках.
К: Да.
М: И вот здесь вот всё это на странице расписано, да.
К: Вот, сентябрь, октябрь, декабрь, да, отлично, вот давайте вот так вот эти три сделаем.
М: И здесь же тогда в таблице подпишу, каким тегом, каким цветом выделили.
К: Да, или просто этот цвет здесь же отметьте.
М: Угу, хорошо.
К: И подпишите, да, можно.
М: Хорошо, хорошо, давайте так и сделаем, чтобы нам было понятно, чтобы мы видели, допустим, тот же самый сентябрь у нас выходит, определённые запросы, которые мы на этот месяц определили или нет. Вот так, зеленом у нас с вами есть, у нас с вами зелёным выделено, а…
К: Это я просто, это для примера, что вот…
М: Угу, хорошо.
К: Вы потом измените.
М: Хорошо, хорошо, давайте тогда так и сделаем. У нас с вами сейчас на данный момент получается выполнено раз, два, три, четыре, пять, шесть…
К: Угу.
М: Шесть задач из двенадцати. А, ну вот, у нас с вами добавилось, добавилось восстановление…
К: Это ООО, ИП…
М: Бэкапа, да.
К: Нет, нет, да. ООО, ИП, да, да, добавился, это нужно, потому что, мне кажется, мы там в топе покажемся, сразу будем привлекать.
М: Угу, хорошо. Ну её мы в любом случае сделаем, она у нас задача стоит в работе, пока точно сориентировать по числу не могу.
К: Угу.
М: Добавила период с двадцать пятого по двадцать девятое, в это время по-любому сделаем мы, как восстановим, уже сможем…
К: Угу.
М: Оценить, какой контент там был, потому что именно с тем контентом вы занимали лидирующие позиции, получали лиды.
К: Угу.
М: И этот контент нам, вероятно, придётся дополнить в любом случае.
К: Да.
М: И уже тогда создадим страницы, перед тем как создавать страницы, соответственно, вам всё вышлю на…
К: Угу.
М: Согласование.
К: Хорошо, хорошо.
М: Вот, Булат, пока направлю вам счёт на август…
К: Ага.
М: Ой, извините, на сентябрь. Сориентируйте по срокам, какого числа могу ожидать оплату, в конце месяца?
К: Угу, в конце месяца проведём, в конце месяца проведём, да, нам надо видеть, что с работой всё выполнено.
М: Угу, хорошо, хорошо, хорошо, конечно. Всё, тогда счет направляю, если будут вопросы, звоните, пишите, я на связи.
К: Хорошо, до свидания, угу.
М: Да, всего доброго, до свидания.
К: Всего доброго.
"""

    result = asyncio.run(process_client_data(sample_dialogue1, example_data))
    print(result)