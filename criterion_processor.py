import asyncio
import json
from functools import partial
from llm_router import llm_request

# Пояснение
PROMPT1 = """
Тебе предоставлен транскрипт разговора менеджера с клиентом. Менеджер обозначен буквой М, а клиент буквой К. ВНИМАНИЕ! 
Не спутай фразы менеджера и клиента.
"""
# PROMPT2 всегда включается в запрос
PROMPT2 = """
Ответ выдай строго в виде словаря следующего синтаксиса (без доп символов и кавычек, синтаксис словаря должен быть с 
таким же набором фигурных скобок и двойных кавычек, обрамлять словарь в доп символы запрещено):
{"text": "ответ на промпт", "evaluation": оценка по шкале от 1 до 100 в рамках промпта} 
Если в основном ответе ты не нашел никакой информации, то ставь оценку null. Оценка ставится только в ключе evaluation, в ключе text оценки ставить запрещено.
Кроме словаря вставлять что-то в ответ запрещено.
Кавычки внутри значения ключа text обязательно экранируй.
"""


async def process_client_data(dialogue: str, data: dict) -> dict:
    """
    Асинхронная функция, принимающая на вход словарь формата:
    {
        "id": <число>,
        "group_id": <число>,
        "name": <текст>,
        "prompt": <текст>,
        "show_text_description": <bool>,
        "evaluate_criterion": <bool>,
        "include_in_score": <bool>,
        "include_in_entity_description": <bool>,
        "llm_type": <строка>
    }

    Логика работы:
      - Если оба флага "show_text_description" и "evaluate_criterion" равны False, то запрос к ChatGPT не выполняется,
        а возвращается словарь с пустым текстом и оценкой None.
      - В противном случае:
          - Формируется prompt из PROMPT1, содержимого поля "prompt", текста диалога и всегда добавляется PROMPT2.
          - Отправляется запрос к ChatGPT.
          - Ответ парсится как JSON-словарь вида {"text": "...", "evaluation": ...}.
          - Если в ответе evaluation не None, то, если evaluate_criterion == True, делится значение на 20 и округляется до одной десятичной.
      - После получения ответа:
          - Если "show_text_description" == False, итоговый "text" заменяется на пустую строку.
          - Если "evaluate_criterion" == False, итоговая "evaluation" заменяется на None.
      - Возвращается словарь, содержащий только ключи "text" и "evaluation".
    """
    show_text = data.get("show_text_description", False)
    eval_crit = data.get("evaluate_criterion", False)

    # Если оба флага False, запрос не выполняется.
    if not show_text and not eval_crit:
        return {"text": "", "evaluation": None}

    description = data.get("prompt", "")
    prompt = f"{PROMPT1}{description}\nТекст диалога:{dialogue}{PROMPT2}"
    print(prompt)

    messages = [
        {"role": "user", "content": prompt}
    ]

    loop = asyncio.get_running_loop()
    # Выполняем блокирующий вызов в отдельном потоке через run_in_executor
    response = await loop.run_in_executor(
        None,
        partial(llm_request,
                model="gpt-4o-mini",
                messages=messages)
    )

    response_content = response.get("content", "")
    try:
        parsed_json = json.loads(response_content)
    except json.JSONDecodeError as e:
        print(f"Ошибка при парсинге JSON: {e}")
        print(f"Содержимое response_content: {response_content}")
        raise

    text = parsed_json.get("text")
    eval_raw = parsed_json.get("evaluation")

    if eval_raw is not None and eval_crit:
        eval_raw = round(float(eval_raw) / 20, 1)

    if not show_text:
        text = ""
    if not eval_crit:
        eval_raw = None

    return {"text": text, "evaluation": eval_raw}


# Примеры использования:
if __name__ == "__main__":
    example_data = {
        "id": 12,
        "group_id": 2,
        "name": "Подведение итогов",
        "prompt": """
        Проанализируй диалог, выдели фразы менеджера и проанализируй фразы на наличие подведения итогов в конце диалога с клиентом согласно пунктам:
        - должно договориться о следующем контакте;
        - должно сообщить дальнейшие шаги;
        - должно обозначить конкретные сроки;
        - должно повторить клиенту его цели и потребности;
        - должно получить от клиента подтверждение или согласие.
        Представь ответ единым МАРКИРОВАННЫМ списком (тире в начале пункта), где в каждом пункте идет твое резюме по каждому из указанных пунктов, и приведены примеры из текста (если примеры есть).
        Слово «менеджер» не нужно употреблять в ответе, например вместо: менеджер говорит недостаточно ясно – пиши: говорит недостаточно ясно.
        """,
        "show_text_description": True,
        "evaluate_criterion": True,
        "include_in_score": True,
        "include_in_entity_description": False,
        "llm_type": "standard"
    }

    sample_dialogue1 = """
М: Добрый день.
К: Алло, здравствуйте.
М: Здравствуйте.
К: Я позвонила в АдвертПро.
М: Да, все верно.
К: Попала? Да, хотела бы обсудить вот продвижение сайта. С кем можно пообщаться?
М: Со мной. Меня Роман зовут. Как вас?
К: Меня зовут Анна.
М: А.
К: Роман, смотрите.
М: Да, угу.
К: Да, ну сразу к делу.
М: Конечно.
К: Да, ищем подрядчика на следующий сезон. Мы компания-производитель жидкой гидроизоляции. Вот, но оказываем услуги по устройству этой гидроизоляции под ключ. То есть у нас больше B2B такой сегмент получается.
М: Угу.
К: Вот, у нас есть сайт по нашим услугам.
М: Угу.
К: И есть подрядчик сейчас, который занимается SEO. То есть мы все уже занимаемся с 2020 года, где-то уже года четыре наверное.
М: Угу, достаточно долго уже. Да, так.
К: Да. То есть, ну, в принципе, какие-то ссылки закупаются, какие-то работы там делаются. То есть там сайт не нулевой. Домен тоже там с какой-то уже с историей.
М: Истории. Угу.
К: Да. Нужна там какая-то раскрутка. То есть есть у него. Вот, я что хотела узнать. Вот сейчас пока вообще просто даже первое такое приближение. Сейчас подбираем подрядчика. Скажите, пожалуйста, вот у вас в среднем цена за работу над сайтом она сколько? Ну, если иметь в виду, что семантическое ядро у нас достаточно небольшое. Да, в принципе, услуга одна — устройство гидроизоляции.
М: Угу.
К: Вот. Ну, и там синонимов там, я не знаю, ну, может быть, штук пятьдесят наверное максимум там.
М: Ну, я понимаю, узкая тематика у вас. Но регионы у вас по всей России?
К: Узко, да, да.
М: Получается.
К: Смотрите, региона у нас нет. У нас Москва, Московская область и ближайшие области. То есть у нас...
М: Ну, понятно. Ну, угу.
К: Ну, да, да. Ну, скорее всего, ну как бы Москва, Московская область и вот какие-то там ну километров пятьсот наверное еще.
М: Так.
К: Вот. И что еще... Какая вот нам, конечно, интересно. То есть вот сейчас SEO-подрядчик, который у нас работает, да, он у нас штатный специалист. Проблема в чем: просто гонит нам трафик, да. То есть как бы и по трафику у нас рост как бы есть. У нас так, у нас наверное в целом за год ну трафик небольшой. У нас там за год выходит где-то 18 тысяч. То есть это где-то по полторы тысячи визитов в месяц. Вот, то есть сейчас вот такие показатели у нас. Вот, но гонят в общем всякий шлак туда.
М: Угу.
К: Вот. А роста заказов мы не видим.
М: Не целевой. Ну, понятно, понятно.
К: Да. То есть, да. То есть там по конкурентам, по каким-то вот инфоповодам туда нам нагоняют. Типа, сегодня День жестянщика, а у нас хорошие цены на гидроизоляцию. Да. Вот нам вот такой вот как бы... Не нужно нам. Лучше меньше.
М: Подход не нужен. Угу, угу. По качеству.
К: Да. Но нам лучше больше заявок. Вот. И нам, конечно, интересны компании, у которых есть опыт работы с такими, ну, примерно с такими компаниями, как мы. То есть это вот какие-то производители...
М: Есть, есть. Да.
К: Да. То есть не .com, а вот какие-то вот такие услуги. Вот, и которые будут заинтересованы именно вот в заявках. Да, нам даже не столь важны топовые позиции. Да, пускай это будет...
М: Угу. Да, мы так работаем. Мы так и работаем. Вот, у нас есть KPI, и в вашем случае я бы, ну, работал по формату абонемент и премия за именно лиды. Вот, но...
К: Вот, да, да, да. Отлично.
М: Но тут есть важные нюансы. Мы обычно... Вы как ведете работу с клиентами? То есть у вас есть CRM или вы как в Excel ведете? Вот.
К: Ну...
М: Как у вас аккаунт?
К: Ну, нет. Да, у нас Битрикс24. Мы работаем. У нас есть CRM. У нас интегрирован. Уже растяжка... Знаю, аналитика.
М: Вот, вот, вот.
К: Снимается. Да, с 2020 года. Соответственно, все предоставляем: все доступы, отчеты быть да.
М: И замечательно, замечательно. Вот, ну, мы в таких проектах работаем комплексно. То есть, ну, я не знаю, у вас это настроено. Скорее всего, у вас есть интегратор какой-то. Да, то есть по Битриксу. То есть, кто поддержку оказывает?
К: Ну...
М: Вот.
К: Ну, не совсем. У нас есть программист, который...
М: Свой? Угу.
К: Работает по Битриксу. Вот, в принципе, но это фриланс. Надо понимать, что нестабильный.
М: А у вас коробочная? У вас коробочная версия или облако?
К: Облако. Нет, ну, у нас облако. Да.
М: Ну, программист там не нужен в облаке. Именно конкретно. Вот, смотрите, расскажу в чем суть идеи. Мы являемся партнерами Битрикса. То есть и интеграторы, и золотые партнеры. И в целом SEO вы нас нашли в топе. Вот, когда клиентам важны ROI, мы работаем по сквозному формату. То есть мы становимся интеграторами по Битриксу: то есть продлеваем лицензию, помогаем там либо оказываем техподдержку. Как у вас программист, например. Вы ему пишете, наверное, он там что-то делает. Ну, или что-то там сломалось, например. Как я представлю. Мы настраиваем все, проверяем цели. Вот, и делаем прогноз по лидам. То есть сколько лидов привлечем и план с вами согласовываем. На первый месяц мы прогноз по лидам не делаем, потому что надо поработать с самим сайтом, вывести его на первые позиции. Вот, как раз вы сказали: шлейф слов примерно пятьдесят запросов. Правильно я понимаю? Ну, такие основные для вас.
М: Ну, да. Может быть, даже меньше. То есть у нас вот тут в программе тот SEO-шник, который работает сейчас, да... Ну, у нас сайт там он посвящен услугам. Но есть раздел, который продает сам материал. То есть, если кому-то нужна эта гидроизоляция, которая сам будет ее наносить, мы, конечно, ее продадим. Вот, и SEO-шник он как раз и пытается гнать трафик вот на эту товарную страницу. А нам как бы вот...
М: Я понимаю. Это бесполезно. Это бесполезно. Я понял ошибку основную. У нас подход немного другой.
К: Да, да.
М: B2B — сложная тематика. Вот, сразу говорю. Поэтому тут чисто уйдет работа на ROI. То есть первое — это позиции. То, что вот вы назвали. Если вы не на первом месте, то по сути трафик вы теряете. Ну, целевой. Вот, именно те заказчики, которые основные. Вот, мы с вами получается обговариваем вот эти цели. То есть собираем конверсию, фильтруем мусорные заявки от немусорных. Нужно цели отцеживать. В том числе и почту, потому что могут писать на почту B2B-закупки там и так далее. Вот.
К: Угу.
М: И мы уже работаем конкретно на план. По стоимости абонемента. Он... Смотрите, дело в том, что ссылки вообще не работают сейчас в Яндексе точно. Вот, поэтому то, что вы закупаете ссылки, это особого результата не принесет на данный момент. Вот, работает поведенческий фактор. Вот, это основное, что дает такой быстрый результат. Вот, я имею в виду топ-1, топ-3. То есть вот самый важный запрос. Потому что даже если вы сейчас уже сами в десятке, ну, допустим, на седьмом месте. Вы, наверное, обратили внимание: сейчас много занимает реклама.
К: Угу.
М: Вот и...
К: Ну, да, конечно.
М: Люди не листают до конца. Вот, люди не решают.
К: Скоро вообще ничего не будет на первой странице, только Яндекс свой сервис.
М: Не, ну, вряд ли. Но к этому идет. Да, я понимаю, о чем вы говорите. Вот, то есть мы делаем под ключ SEO. То есть мы можем с вами как договориться. Ну, минимальный бюджет на 70 тысяч — это с доработками по сайту. То есть туда входят услуги там программиста.
К: Угу.
М: И так далее. То есть мы сами все делаем. То есть вот мы говорим, что надо переделать страницу вот это, вот это, вот это. Согласовываем с вами и сами реализовываем. Если...
К: Угу.
М: У вас есть свой программист, и хотите сами реализовывать, то бюджет будет там в районе 50 тысяч. Вот, тут надо просто сравнивать: дешевле как делать — через нас или через вашего фрилансера. Вот, плюс еще...
К: Ну, да, да, да.
М: Если вам нужно какой-нибудь баннер там разместить, там чаты, хотелки есть. То есть хотелки... То есть мы тоже это делаем, разумеется.
К: Угу.
М: Вот. Ну, такие базовые вещи. Да, то есть.
К: Угу.
М: Ну, обычно выгоднее через нас делать. Ну, тут все надо смотреть: сколько у вас задач обычно бывает, сколько вы платите программистам. Вот, по часам или там оклад вы платите. То есть надо просто сравнивать с экономическим.
К: Угу.
М: Что касаемо поведенческого фактора: если мы будем работать с вами по модели абонемент плюс премия за результат, то он будет входить. Вот, у нас есть просто абонемент с ПФ. Это, допустим, 90 тысяч рублей. Там результат идет практически сразу. Там первый, там второй месяц по SEO. Но нужно, чтобы была видимость. Я думаю, раз вы занимаетесь четыре года, все, вы как минимум там на первой-второй странице присутствуете. Скорее всего под этим запросом. Надо проверить их.
К: Не факт. Я говорю, не факт, что мы присутствуем по каким-то. Может быть, по нескольким, может быть, мы там есть. Да.
М: Странно тогда. Тогда странно очень. Ну, давайте. Как я вам в любом случае, Анна, напишу либо на WhatsApp, там, либо на почту. Перейдем. Вы мне вот эти запросы, которые вас интересуют, пришлете. Хотя бы основные направления. Мы соберем позиции ваши да стартовые. Вот, и посмотрим, в чем причина. Вот, соответственно, после первого месяца мы делаем прогнозы по лидам, беря доступы. Ну, можем там по Битриксу запартнериться, там посмотреть, там интеграцию настроить. И, соответственно, дальше уже план выполняем. Вы оплачиваете премию. Премию тоже индивидуально можем обговорить: стоимость заявки, там процент выполнения плана. Без проблем.
К: Угу.
М: Вот. С первого месяца мы так работать не можем, потому что надо понять, погрузиться в проект, вашу тематику. Ну, мы можем спрогнозировать какие-то количество лидов исходя из вашей статистики. Но это опять же будут не точные данные. Вот. И так же хотел уточнить: вы используете контекстную рекламу дополнительно? Вот, если да, то выхлоп есть от нее какой-то? Вот, по вашему опыту.
К: Ну, да. Ну, смотрите, да. По контексту у нас работает другой подрядчик. То есть тут все хорошо. У нас мы за счет контекста наверное только и как бы существуем. Да, потому что это реально как бы лиды.
М: Понял, понял. Угу.
К: Вот. И, ну, там все налажено.
М: Нет, нет, нет. Я не в плане, чтобы забрать. И просто. Почему я спрашиваю: если он работает, какие запросы наиболее эффективные? Вот. То есть мы просто возьмем эти запросы, чтобы вы с органики забирали. Потому что многие вот B2B-закупщики. Им запрещено с контекста оставлять заявку. То есть им говорят: надо из выдачи брать. Но некоторые компании... У нас такой есть примеры. Потому что рекламу может любой поставщик купить. Да. То есть качественный он, некачественный и добросовестный, и недобросовестный — непонятно.
К: Мы пока... Ну, да, да. Да, работает. Да, работает контекст. Работает более-менее. Угу.
М: Вот. А если вы в топе, то, ну, к вам доверие значит больше. Вот.
К: Угу, угу.
М: Так. По поводу контекста, если что: если он работает хорошо, мы можем запросы просто оттуда взять и посмотреть и их продвинуть. Ну, как вариант.
К: Угу.
М: Так. По поводу предложения. Тогда я вам напишу на WhatsApp. Вы мне, пожалуйста, пришлите ссылку на сайт и приоритетные запросы. Не обязательно прям пятьдесят штук. Вы можете самые основные по вашему мнению. Мы по ним посмотрим. Вот, и сделаем аудит. То есть я вам подготовлю наше видение. То есть что с вашим проектом не так. Ну, по нашему мнению. Да. Вот, что мы рекомендуем сделать и условия. Вот, также небольшой план работ вам предоставлю. Да, на три месяца, чтобы вы могли ознакомиться.
К: Ну, это да, это понятно.
М: Вот.
К: Это можете не предоставлять. Тут понятно. Но...
М: Угу.
К: Да, нам главное вот получить какой-то хотя бы примерный, да, стоимость работ, которые у нас может получаться. Вот, больше в принципе ничего не интересует. Потому что очень давно все как бы... Все работы понятны. И собственно тут как бы... Ну...
М: Тут не совсем. Но видите, вы ссылки закупаете. Они вообще не нужны по сути. Ну, то есть тут такая ситуация: SEO меняется. Вот, мы два года, допустим, на первых позициях. Сейчас то есть у нас есть компании, которые крупнее нас там, типа Ingate, Demis Group и прочее. То есть, но они не могут нас опередить. То есть потому что у них нет технологий. Банально современных. SEO оно развивается. То есть то, что работало три года назад, оно...
К: Ну, ладно. Окей. Да, да, да, да. Все. Я просто очень мало времени. Как бы, я поняла. Хорошо. Давайте все присылайте. Тогда пишите мне в WhatsApp.
М: Угу. Да.
К: Номер у вас определился правильно? Вот, я вам скину.
М: Да, 533 на конце. Я вам сейчас все напишу, Анна.
К: Угу. Да, да, да. Давайте тогда это и продолжим.
М: Угу.
К: Потом тогда еще...
М: Все, хорошо. Да, договорились.
К: Угу. Да, спасибо. Угу. Жду тогда. Спасибо.
"""

    sample_dialogue = """
М: Алло.
К: Алло, здравствуйте.
М: Здравствуйте.
К: Я по поводу обращаюсь по поводу создания сайтов.
М: Угу.
К: Скажите, пожалуйста, под ключ делаете?
М: Да, конечно. Вы хотите потом подвязать под все?
К: Да, SEO, Яндекс, все под ключ, на долгой основе любить друг друга многие годы, или как?
М: Года, все верно. Мы так и работаем, в основном так берем на SEO.
К: Замечательно. У меня металлические входные двери, я хочу элитный сайт. Вы вывели несколько сайтов в топ 10, я хочу также быть в топе 10.
М: Я понял. Ну, смотрите, у вас по Москве мы не сможем продвигать, потому что у нас там свои сайты, можем в других регионах, если вы там, допустим, по всей России работаете. Вы на Москву только в основном?
К: Москва, Московская область, ну.
М: Вот, ну, смотрите, а у вас постоянные сайты, которые в топе, это наш сайт в том числе, то есть они нам принадлежат. А у вас только получается противопожарные, да, двери, то есть межкомнатных нет?
К: Элитные, межкомнатные, да, межкомнатных нет, только элитные то, что там есть.
М: А, премиум, премиум, коттеджи, коттеджи?
К: Премиум класс, да, да, совершенно верно.
М: Ну, по премиум, если мы вас будем именно в премиум сегменте продвигать, я думаю, можно, потому что у нас двери сидят просто по высокочастотным, то есть там, ну, общие, хотя в коттедже тоже мы в топе. Я обсужу, но разработка сайта, вы понимаете, там должен быть каталог достаточно большой или у вас на заказ какой-то идет, то есть какие-то эксклюзивные двери, можете делать ковка какая-то?
К: Ну, эксклюзивно я могу, как говорится, может быть, один из ваших сайтов показать, да, не знаю, пару сайтов просто для примера дать.
М: Угу.
К: И все.
М: Я понял. Ну, смотрите, я это.
К: Сейчас же, когда я извиняюсь, когда раньше делали, да, и я там делал первые сайты, то там.
М: Ага, да.
К: Искал, а сейчас есть и Pinterest, там, где там тысячи моих даже дверей, которых я лично делал, там они уже есть, поэтому сейчас уже легче.
М: Ну, смотрите, тут вопрос в стоимости, то есть у нас такие сайты, там, большие стоят где-то от шестиста тысяч вот под разработку вот, потому что там большой каталог и, ну, большая работа. Вот, если брать там на Битриксе сайт именно как интернет магазин под доменами в Подмосковье же дома, коттеджи находятся, то есть надо под замены делать, то есть тут полноценная работа SEO потом где-то в районе семидесяти-ста тысяч в месяц стоит.
К: Угу, угу.
М: Продвижение вот, поэтому первый этап разработка, то есть мы выбираем там структуру, там, отрисовку логотип, ну, то есть все, что необходимо и уже реализовываем. Понимаете, единственное, что момент согласовать, узнать, можем ли мы взять вот как элитные двери, потому что у нас стоп стоит набрать именно двери на продвижение по Москве, чтобы не конкурировать с самим собой, вот, я поэтому уточню, но если там ритм, я думаю, может быть, согласуют и сделаем вам смету от предложения.
К: А у вас получается вы делаете разве там нет, ну, не элитных, грубо скажем, а в коттедже те же, потому что у меня также будет и в квартиру.
М: Ну, коттеджи мы двигаем, но там в основном пласта лидов там не в коттедже идет, а просто вот противопожарные двери, металлические входные, то есть там в основном так, ну, я уточню, вот если можем взять, то.
К: Да, меня, меня это противопожарная, меня не волнует, там если будет одна карточка, что мы делаем пожарки и все, а так меня они не волнуют, меня больше волнует это коттеджи и, соответственно, волнует где нигде квартирки.
М: Угу, угу, я понял, я понял, уточню тогда у коллег и так, давайте могу вам в WhatsApp написать по этому номеру, вот.
К: Да, да, Евгений.
М: Евгений, меня Роман зовут, вот, я вам сейчас напишу и в любом случае сегодня сообщу по обратной связи.
К: Да, только у меня сразу.
М: Да.
К: Одно условие это все под ключ.
М: Ну, конечно, конечно, мы под ключ работаем, то есть я вам.
К: Просто, да, чтобы потом не было, дай мне, делай SEO кому-то, просто я тоже сейчас обзваниваю, они там ищи кто будет делать или ищи кто кто его будет делать.
М: Нет, так и есть, так и есть, то есть мы под ключ делаем, вот, другие компании не могут делать как мы, в большинстве своем, то есть мы в дверях это ну самое. Мы с 2006 года дверями занимаемся, вот именно как тематикой, вот у нас новый проект сайтов, вот, поэтому я просто узнаю можно ли нельзя ли взять в работу, вот, если можно, то я вам уже развернутое предложение подготовлю, мы с вами все детали обсудим и расскажу, что нужно там для начала сотрудничества.
К: Ну, все равно получается конкуренция она же идет, какая разница кто будет создавать сайт?
М: Не, ну, смотрите, мы просто живем за счет лидов с этих дверей, то есть мы продаем лиды, то есть у нас сайт нам принадлежит, мы вашим коллегам заявки подаем с него, вот с этих сайтов, которые вот вы видите в топе, вот, то есть мы сами себе.
К: А сколько лиды у вас стоят или вы отдельно только продаете?
М: Ну, Москва у нас сдана полностью, вот, ну, так в среднем, наверное, от четырехсот рублей где то и стоит.
К: А как записаться к вам?
М: Ну.
К: На прием?
М: Проблемы все занято пока, то есть если там соседние какие-то области можно посмотреть, но опять же у вас же премиум, то есть вам же не нужны все ряды, там, которые дешевые, например, ну, как дешевые.
К: Да, почему, у меня есть менеджер, есть кому обрабатывать, почему?
М: Ну, ну, вряд ли просто сейчас я сам сдал сайт на прошлой неделе, на прошлом месяце, там, на двести тысяч, наверное, лидов, там, новая, мы сдали, не знаю, сейчас спрошу есть свободные или нет, в любом случае, Евгений, я вам сообщу, вот.
К: Будет обрабатывать.
М: Как будет действовать.
К: Да, держите, пожалуйста, да.
М: Все, вот если что на связи, я вам там в чат напишу, вы можете тогда написать вопрос.
К: Да, да, да, спасибо, буду ждать.
М: До свидания.
"""

    sample_dialogue2 = """"
М: Здравствуйте! Меня зовут Михаил, я представляю компанию "ТопРанк". Мы специализируемся на SEO-продвижении бизнеса в интернете. Спасибо, что согласились на встречу. Расскажите, пожалуйста, о вашей компании и целях, которые вы хотите достичь с помощью интернет-маркетинга.
К: Добрый день, Михаил. Я Алексей, владелец интернет-магазина товаров для дома "ДомоСфера". Мы на рынке около трех лет, но в последнее время наши продажи через сайт снизились. Конкуренты активно развиваются, и мы теряем позиции. Хотим это исправить.
М: Понятно, Алексей. Такая ситуация действительно требует комплексного подхода. Давайте я расскажу, как наша SEO-стратегия может помочь вам вернуть и усилить позиции. Мы проведем полный аудит вашего сайта, оптимизируем контент и техническую часть, построим качественную ссылочную массу. В результате ваш сайт получит больше органического трафика и, следовательно, больше заказов. У нас есть успешные кейсы именно в вашей нише.
К: Звучит неплохо, но сколько времени займет, чтобы увидеть результаты? Мне нужно быстрое решение. Конкуренты не дремлют.
М: Хороший вопрос. SEO — это стратегия, которая дает долгосрочные и стабильные результаты, но требует времени. Первые улучшения в позициях можно заметить уже через 2-3 недели после начала работ, однако полноценный эффект наступает через 3-4 месяца планомерной работы. Это связано с тем, что поисковым системам нужно время, чтобы заново проиндексировать сайт и оценить изменения. Зато потом результаты будут держаться долго, в отличие от платной рекламы, которая работает только пока вы платите.
К: Четыре месяца? Это слишком долго. У меня сейчас спад продаж, я не могу столько ждать.
М: Я понимаю вашу обеспокоенность, Алексей. Поэтому мы предлагаем комбинированный подход. Пока SEO набирает обороты, мы можем параллельно запустить контекстную рекламу и таргетинг в социальных сетях. Это даст быстрый приток клиентов уже в первые дни. А SEO постепенно будет усиливать эффект и в долгосрочной перспективе существенно снизит стоимость привлечения клиента.
К: Реклама у меня уже запущена, но результаты не впечатляют. Какие гарантии, что ваше SEO сработает лучше?
М: В SEO нельзя дать 100% гарантий на конкретные позиции — это запрещено правилами поисковых систем, и любая компания, которая обещает вам первое место по всем запросам, вводит вас в заблуждение. Что мы можем гарантировать: прозрачность работы, регулярную отчетность и конкретные метрики роста. Перед началом работы мы проведем анализ вашей ниши и сделаем прогноз роста трафика. В среднем наши клиенты получают увеличение органического трафика на 30-50% в первые полгода работы. Также мы заключаем договор с SLA, где прописаны все обязательства и условия сотрудничества.
К: Хорошо, допустим. А как насчет стоимости? SEO обычно дорогое удовольствие, а у меня сейчас не лучшие времена с точки зрения бюджета.
М: Алексей, мы предлагаем различные пакеты услуг в зависимости от масштаба бизнеса и задач. Базовый пакет для интернет-магазина вашего размера составляет 80 000 рублей в месяц. Но учитывая, что вы только начинаете работать с нами, и принимая во внимание временное снижение ваших продаж, мы готовы предложить особые условия: первые три месяца со скидкой 20%, то есть 64 000 рублей в месяц. Плюс бесплатный аудит сайта и рекламных кампаний. Если сравнить эту сумму с затратами на контекстную рекламу в вашей конкурентной нише, то SEO в долгосрочной перспективе выходит в несколько раз дешевле по стоимости привлечения клиента.
К: 64 000 рублей в месяц — это все равно серьезная сумма. Особенно учитывая, что я не вижу мгновенных результатов. А что, если я заплачу, а вы не сможете улучшить мои позиции?
М: Я понимаю ваши опасения. Чтобы снизить риски, мы предлагаем следующее: мы разбиваем работу на этапы с промежуточными результатами. После первого месяца вы увидите конкретный отчет о проделанной работе: технические исправления, оптимизированные страницы, подготовленный контент. Мы также зафиксируем в договоре минимальный прирост ключевых показателей через 3 месяца. Если мы не достигнем оговоренных метрик, вы получите месяц работы бесплатно. Такой подход?
К: Допустим. Но у меня уже был негативный опыт с SEO-агентством. Они обещали золотые горы, а в итоге я потратил деньги впустую. Откуда мне знать, что вы не такие же?
М: Ваша осторожность абсолютно понятна, Алексей. Плохих исполнителей на рынке действительно много. Вот что я предлагаю: прежде чем принимать решение, посмотрите наши кейсы, особенно в вашей нише. Я могу предоставить контакты наших клиентов, с которыми вы можете лично пообщаться и узнать об опыте работы с нами. Также обратите внимание на состав нашей команды — у нас работают сертифицированные специалисты с опытом от 5 лет. Мы не берем проекты, в успех которых не верим, и всегда честно говорим клиентам о реальных перспективах.
К: Кейсы и отзывы легко подделать. На вашем сайте я вижу впечатляющие результаты, но как я могу быть уверен, что это правда?
М: Справедливое замечание. Именно поэтому я предлагаю вам не просто прочитать отзывы на сайте, а лично пообщаться с нашими клиентами. Я могу организовать для вас звонок или встречу с руководителями компаний, которые уже работают с нами. Кроме того, мы можем показать вам реальные аналитические данные роста трафика и конверсий по нашим проектам непосредственно из Яндекс.Метрики и Google Analytics, с доступом к этим аккаунтам. Таким образом, вы сможете убедиться в достоверности наших результатов.
К: Хорошо, звучит неплохо. Но меня беспокоит еще один момент — насколько ваша команда понимает специфику моего бизнеса? Товары для дома — это особая ниша с сезонностью и своими нюансами.
М: Отличный вопрос, Алексей. В нашем портфолио есть несколько проектов именно в сфере товаров для дома и интерьера. Например, компания "Интерио" и "ДомПлюс" — возможно, вы знаете этих игроков рынка. Мы хорошо понимаем специфику и сезонность в вашей нише. В нашей команде есть контент-маркетологи, которые специализируются именно на этом сегменте. Более того, перед стартом работ мы проведем детальное исследование вашей аудитории и конкурентов, чтобы точно понимать, какие запросы и в какие сезоны дают максимальный эффект.
К: Ваши клиенты — это мои прямые конкуренты. Разве это не конфликт интересов? Вы будете продвигать и их, и меня одновременно?
М: Отличное замечание. Мы очень серьезно относимся к вопросу конфликта интересов. С "Интерио" мы работали два года назад, сейчас этот проект закрыт. С "ДомПлюс" у нас был краткосрочный проект по другому направлению — они запускали новую линейку товаров для сада, что не пересекается с вашим основным ассортиментом. У нас есть строгое правило: мы не берем в работу прямых конкурентов в одно и то же время. Если мы начинаем сотрудничество с вами, мы гарантируем, что не будем работать с другими интернет-магазинами товаров для дома в том же ценовом сегменте и регионе.
К: Хорошо, это важно. А что насчет отчетности? Я хочу полностью понимать, за что плачу и какие результаты получаю.
М: Прозрачность — один из наших ключевых принципов. Мы предоставляем подробные ежемесячные отчеты с понятной визуализацией всех ключевых метрик: позиции сайта, динамика трафика, поведение пользователей, конверсии. Кроме того, для вас будет создан личный кабинет с доступом к онлайн-дашборду, где вы в режиме реального времени сможете видеть все изменения. Раз в месяц мы проводим подробную презентацию результатов с разбором проделанной работы и планов на следующий период. Вы всегда будете точно знать, какие работы были выполнены и какой эффект они принесли.
К: Звучит хорошо, но не слишком ли это сложно? У меня нет времени разбираться во всех этих метриках и отчетах.
М: Я прекрасно понимаю, что у вас как у руководителя много других задач. Именно поэтому мы делаем два типа отчетов: подробный технический для вашего маркетолога или другого ответственного сотрудника и сжатый управленческий отчет лично для вас. В управленческом отчете всего 2-3 страницы с ключевыми показателями и выводами — вы потратите максимум 10 минут, чтобы полностью понять ситуацию. При этом ваш персональный менеджер всегда готов ответить на любые вопросы и предоставить более детальную информацию по запросу.
К: А если я захочу прекратить сотрудничество? Какие условия расторжения договора?
М: Мы ценим долгосрочные отношения, но понимаем, что ситуации бывают разные. В нашем договоре предусмотрена возможность расторжения с уведомлением за 30 дней. При этом все наработанные материалы, стратегии и рекомендации остаются у вас. Более того, мы подготовим финальный отчет с рекомендациями по дальнейшему развитию, чтобы вы могли продолжить работу самостоятельно или с другим подрядчиком. Наша цель — чтобы вы были довольны сотрудничеством, даже если оно завершится.
К: Хорошо, а как вы будете взаимодействовать с моей командой? У меня есть маркетолог и технический специалист, которые занимаются сайтом.
М: Мы приветствуем совместную работу с вашей командой — это всегда повышает эффективность. Мы предлагаем следующую схему: в начале проекта проводим установочную встречу со всеми участниками, определяем зоны ответственности и каналы коммуникации. Создаем общий чат в мессенджере для оперативных вопросов и используем таск-менеджер для отслеживания задач. Ваш маркетолог может участвовать в разработке контент-стратегии, а технический специалист — в обсуждении технических аспектов оптимизации. Мы не "черный ящик", а партнер, который готов делиться знаниями и инструментами.
К: Мой технический специалист говорит, что мой сайт и так хорошо оптимизирован. Зачем мне платить за то, что уже сделано?
М: Это хороший знак, что у вас есть техническая база. Однако, SEO — это непрерывный процесс, а не разовая настройка. Поисковые алгоритмы постоянно меняются, конкуренты не стоят на месте, а пользовательские предпочтения эволюционируют. Перед началом работы мы проведем бесплатный аудит вашего сайта с использованием профессиональных инструментов, которые часто выявляют проблемы, незаметные при обычном обслуживании. Наш аудит охватывает более 200 технических параметров, анализ пользовательского опыта и коммерческих факторов. Даже если базовая оптимизация проведена хорошо, мы найдем точки роста и новые возможности для улучшения.
К: Вы много говорите о контенте. Но кто будет его писать? У меня более 5000 товаров, это огромный объем работы.
М: Действительно, контент — важная часть SEO-стратегии. У нас есть своя команда копирайтеров, специализирующихся на разных тематиках, включая товары для дома. Но мы понимаем, что 5000 товаров — это большой объем. Поэтому мы используем кластерный подход: сначала оптимизируем ключевые категории и самые важные товары, которые приносят основной трафик и продажи. Затем переходим к остальным группам по приоритету. Также мы разрабатываем шаблоны описаний для однотипных товаров, чтобы ваша команда могла масштабировать эту работу самостоятельно. И конечно, мы учитываем уже существующий контент — нет смысла переписывать то, что хорошо работает.
К: Что произойдет, если во время вашей работы мои позиции в поиске внезапно упадут? Такое иногда случается при SEO-оптимизации, насколько я знаю.
М: Вы правы, такой риск существует, особенно при серьезных изменениях на сайте. Мы минимизируем его несколькими способами. Во-первых, перед внедрением всех изменений мы делаем резервные копии, чтобы иметь возможность быстро вернуться к рабочей версии. Во-вторых, мы проводим изменения поэтапно, отслеживая реакцию поисковых систем на каждый шаг. В-третьих, у нас есть специалисты по антикризисному SEO, которые могут быстро реагировать на падения. Если падение все же произойдет, мы немедленно проанализируем причины и предпримем необходимые действия для восстановления. Исходя из нашего опыта, при правильном подходе серьезные падения случаются редко, а если и случаются, то восстановление происходит быстро.
К: Как вы относитесь к "серым" методам продвижения? Некоторые агентства предлагают быстрый результат за счет не совсем легальных методов.
М: Мы категорически против любых "серых" и тем более "черных" методов продвижения. Такие подходы могут дать краткосрочный эффект, но почти всегда заканчиваются санкциями со стороны поисковых систем, вплоть до полного исключения сайта из индекса. Восстановление после таких санкций может занять месяцы или даже быть невозможным. Мы работаем только белыми методами, которые соответствуют рекомендациям поисковых систем. Да, это требует больше времени, но зато дает стабильный и долгосрочный результат. Наш принцип — не рисковать бизнесом клиента ради быстрых побед.
К: У меня уже есть контракт с компанией, которая занимается моими социальными сетями. Как вы будете взаимодействовать с ними?
М: Это отличная возможность для синергии. Мы готовы наладить сотрудничество с вашими SMM-специалистами, чтобы усилить общий эффект. Например, мы можем предоставить им аналитику по самым популярным поисковым запросам для создания релевантного контента в социальных сетях. А они могут помочь нам с привлечением трафика на важные страницы сайта через социальные сети. Мы проведем совместную встречу, чтобы согласовать стратегию и точки взаимодействия. У нас есть успешный опыт такого сотрудничества с SMM-агентствами на других проектах.
К: Ладно, вы меня почти убедили. Но давайте поговорим о конкретных цифрах. Какой рост трафика и продаж вы прогнозируете для моего сайта?
М: Для точного прогноза нам нужно провести детальный анализ вашего сайта, конкурентов и ниши. Но основываясь на предварительной оценке и нашем опыте работы в сегменте товаров для дома, могу дать примерный прогноз: в течение первых 3 месяцев работы — рост органического трафика на 15-20%, через 6 месяцев — на 40-50%. Что касается конверсии в продажи, здесь многое зависит от текущих показателей вашего сайта и проблемных мест. В среднем наши клиенты наблюдают рост конверсии на 10-15% за счет улучшения поведенческих факторов и оптимизации страниц товаров и корзины. Но давайте после аудита я предоставлю вам детальный прогноз с разбивкой по месяцам и каналам.
К: Хорошо, я готов рассмотреть ваше предложение. Как будет выглядеть наше дальнейшее сотрудничество?
М: Отлично, Алексей! Вот наш план действий: сначала мы проведем бесплатный аудит вашего сайта — это займет около недели. После этого я подготовлю для вас коммерческое предложение с детальной стратегией и прогнозами, которые мы обсудим на встрече. Если все условия вас устроят, мы подпишем договор и сразу приступим к работе. Первый этап — глубокий анализ и формирование стратегии — займет около двух недель, после чего начнется активная фаза оптимизации. Я буду вашим персональным менеджером на всех этапах проекта, всегда на связи по любым вопросам. Когда вам удобно начать с аудита сайта?
К: Думаю, можно начать со следующей недели. Отправьте мне, пожалуйста, список того, что вам понадобится для аудита, и контакты для связи. Я перенаправлю эту информацию своему техническому специалисту.
М: Отлично, Алексей! Я отправлю вам всю необходимую информацию сегодня до конца дня. Для проведения аудита нам понадобится доступ к вашей аналитике (Яндекс.Метрика и Google Analytics) и Search Console. Если у вас есть какие-то дополнительные вопросы или пожелания, не стесняйтесь обращаться в любое время. Я рад, что мы начинаем сотрудничество, и уверен, что вместе мы сможем значительно улучшить позиции вашего магазина в поисковой выдаче и увеличить продажи.
К: Надеюсь на результативное сотрудничество. До связи!
М: Я тоже! До связи, Алексей, и хорошего вам дня!
"""

    result = asyncio.run(process_client_data(sample_dialogue1, example_data))
    print(result)